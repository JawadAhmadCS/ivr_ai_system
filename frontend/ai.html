<!DOCTYPE html>
<html>
<head>
<title>AI Assistant</title>
<style>
body{font-family:arial;background:#111;color:#fff;padding:40px}
#chat{height:400px;overflow:auto;border:1px solid #444;padding:10px;margin-bottom:10px}
input{width:80%;padding:10px}
button{padding:10px}
</style>
</head>

<body>

<h2>AI Assistant</h2>
<div id="chat"></div>

<input id="msg" placeholder="Type message"/>
<button onclick="send()">Send</button>

<script>
const API_BASE = (() => {
  const isLocalStaticFrontend =
    (window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1" ||
      window.location.hostname === "::1") &&
    window.location.port === "8000";

  const apiOrigin = isLocalStaticFrontend
    ? window.location.origin.replace(":8000", ":5050")
    : window.location.origin;

  return isLocalStaticFrontend ? apiOrigin : `${apiOrigin}/api`;
})();

function authHeaders() {
  const headers = { "Content-Type": "application/json" };
  const token = localStorage.getItem("auth_token") || "";
  if (token) headers.Authorization = `Bearer ${token}`;
  return headers;
}

async function send(){
let msg = document.getElementById("msg").value
if(!msg) return

document.getElementById("chat").innerHTML += "<b>You:</b> "+msg+"<br>"

try{
let r = await fetch(`${API_BASE}/chat`,{
method:"POST",
headers:authHeaders(),
body:JSON.stringify({message:msg})
})

let data = await r.json()
if(!r.ok || !data.reply){
throw new Error(data?.detail || (r.status === 401 ? "Unauthorized" : "chat failed"))
}

document.getElementById("chat").innerHTML += "<b>AI:</b> "+data.reply+"<br><br>"
}catch(e){
const message = String(e?.message || "");
const note = message.includes("Unauthorized")
  ? "Please login from dashboard first."
  : "Server error, we will fix soon.";
document.getElementById("chat").innerHTML += "<b>AI:</b> "+note+"<br><br>"
}
}
</script>

</body>
</html>
