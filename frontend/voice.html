<!DOCTYPE html>
<html>
<head>
<title>AI Admin</title>
<style>
body{background:#0f172a;color:#fff;font-family:arial;margin:0}
.sidebar{width:250px;height:100vh;background:#020617;position:fixed;padding:20px}
.sidebar button{width:100%;margin:6px 0;padding:12px;background:#111827;border:0;color:#fff;cursor:pointer}
.main{margin-left:270px;padding:30px}
.card{background:#020617;padding:20px;margin-bottom:20px;border-radius:10px}
textarea,input{width:100%;padding:10px;margin-top:10px;background:#000;color:#fff;border:1px solid #333}
button.primary{background:#2563eb;padding:12px;border:0;margin-top:10px;color:#fff;cursor:pointer}
#chat{height:200px;overflow:auto;background:#000;padding:10px}
</style>
</head>

<body>

<div class="sidebar">
<h2>Admin</h2>
<button onclick="show('dashboard')">Dashboard</button> 
<button onclick="show('restaurants')">Restaurants</button>
<button onclick="show('calls')">Call Logs</button>
<button onclick="show('ai')">AI Chat</button>
<button onclick="show('voice')">Voice Test</button>
</div>

<div class="main">

<!-- CALL LOGS -->

<div id="calls" class="page" style="display:none">
<div class="card">
<h3>Call Logs</h3>
<div id="calllogs">No logs yet</div>
</div>
</div>

<!-- DASHBOARD -->

<div id="dashboard" class="page">
<div class="card"><div class="stat" id="rCount">0</div>Active Restaurants</div>
<div class="card"><div class="stat" id="callCount">0</div>Total Calls Today</div>
<div class="card"><div class="stat" id="missed">0</div>Missed Calls</div>
<div class="card"><div class="stat" id="avg">0s</div>Avg Duration</div>
<div class="card"><div class="stat" id="api">0</div>API Usage</div>
<div class="card"><div class="stat" id="cost">$0</div>Usage Cost</div>
</div>

<div id="restaurants" class="page">
<div class="card">
<h3>Create Restaurant Agent</h3>
<textarea id="newPrompt" placeholder="Restaurant system prompt"></textarea>
<button class="primary" onclick="createR()">Create</button>
</div>

<div class="card">
<h3>Default Prompt (all)</h3>
<textarea id="defaultPrompt"></textarea>
<button class="primary" onclick="updateDefault()">Update Default</button>
</div>

<div class="card">
<h3>Restaurant List</h3>
<div id="list"></div>
</div>
</div>

<div id="ai" class="page" style="display:none">
<div class="card">
<select id="ridSelect"></select>
<div id="chat"></div>
<input id="msg">
<button onclick="sendChat()">Send</button>
</div>
</div>

<div id="voice" class="page" style="display:none">
<div class="card">
<select id="voiceRid"></select>
<button onclick="startVoice()">Start Voice</button>
</div>
</div>

</div>

<script>
const API_BASE = (() => {
  const isLocalStaticFrontend =
    (window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1" ||
      window.location.hostname === "::1") &&
    window.location.port === "8000";

  const apiOrigin = isLocalStaticFrontend
    ? window.location.origin.replace(":8000", ":5050")
    : window.location.origin;

  return isLocalStaticFrontend ? apiOrigin : `${apiOrigin}/api`;
})();

function show(id){
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(id).style.display = "block";
}

async function loadDefaultPrompt(){
  try {
    const r = await fetch(`${API_BASE}/prompt/`);
    const data = await r.json();
    defaultPrompt.value = data.prompt || "";
  } catch(e) {}
}

async function load(){
  const r = await fetch(`${API_BASE}/restaurants/`);
  const data = await r.json();

  let html = "";
  ridSelect.innerHTML = "";
  voiceRid.innerHTML = "";

  data.forEach(item => {
    const id = item.id;
    const prompt = item.ivr_text || "";
    const name = item.name || `Restaurant ${id}`;

    html += `
<div style="border-bottom:1px solid #333;padding:10px">
<b>${name}</b> (ID: ${id})
<textarea onchange="updateRestaurant(${id}, this.value)">${prompt}</textarea>
</div>`;

    ridSelect.innerHTML += `<option value="${id}">${name}</option>`;
    voiceRid.innerHTML += `<option value="${id}">${name}</option>`;
  });

  list.innerHTML = html;
}

async function createR(){
  const prompt = newPrompt.value.trim();
  if (!prompt) return;
  await fetch(`${API_BASE}/restaurants/add`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name:`Restaurant ${Date.now()}`, phone:"", ivr_text:prompt})
  });
  newPrompt.value = "";
  load();
}

async function updateRestaurant(id, prompt){
  await fetch(`${API_BASE}/restaurants/${id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ivr_text: prompt})
  });
}

async function updateDefault(){
  await fetch(`${API_BASE}/prompt/save`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({content: defaultPrompt.value})
  });
}

async function sendChat(){
  const msg = document.getElementById("msg").value;
  const rid = Number(ridSelect.value);
  if (!msg) return;

  chat.innerHTML += "<b>You:</b> " + msg + "<br>";

  try {
    const r = await fetch(`${API_BASE}/chat`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message: msg, restaurant_id: rid})
    });
    const d = await r.json();
    if (!r.ok || !d.reply) throw new Error(d?.detail || "chat failed");
    chat.innerHTML += "<b>AI:</b> " + d.reply + "<br><br>";
  } catch(e) {
    chat.innerHTML += "<b>AI:</b> Server error, we will fix soon.<br><br>";
  }
}

async function startVoice(){
  const rid = Number(voiceRid.value);
  if (!window.isSecureContext || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    alert("Voice requires HTTPS (or localhost) with microphone access.");
    return;
  }

  const tokenResponse = await fetch(`${API_BASE}/voice-session`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({restaurant_id: rid})
  });
  const session = await tokenResponse.json();
  const EPHEMERAL_KEY = session?.client_secret?.value;
  if (!EPHEMERAL_KEY) {
    alert("Voice session error");
    return;
  }

  const pc = new RTCPeerConnection();
  const audioEl = document.createElement("audio");
  audioEl.autoplay = true;
  pc.ontrack = e => audioEl.srcObject = e.streams[0];

  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const sdpResponse = await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview", {
    method:"POST",
    body: offer.sdp,
    headers:{Authorization:`Bearer ${EPHEMERAL_KEY}`,"Content-Type":"application/sdp"}
  });

  const answer = {type:"answer", sdp: await sdpResponse.text()};
  await pc.setRemoteDescription(answer);
}

loadDefaultPrompt();
load();
</script>
</body>
</html>
