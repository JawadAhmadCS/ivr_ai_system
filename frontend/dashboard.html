<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceIQ ‚Äî Restaurant IVR Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1220;
    --surface2: #111827;
    --border: #1e2d45;
    --accent: #0ea5e9;
    --accent2: #38bdf8;
    --accent-glow: rgba(14,165,233,0.15);
    --green: #10b981;
    --red: #f43f5e;
    --amber: #f59e0b;
    --text: #f0f6ff;
    --muted: #64748b;
    --subtle: #1e293b;
    --radius: 12px;
    --radius-sm: 8px;
    --sidebar-w: 220px;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    direction: ltr;
  }

  /* RTL body override */
  body[dir="rtl"] {
    font-family: 'DM Sans', 'Segoe UI', Arial, sans-serif;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% -10%, rgba(14,165,233,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(56,189,248,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    position: fixed;
    top: 0; bottom: 0;
    left: 0;
    right: auto;
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
  }

  .logo {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), #0284c7);
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    box-shadow: 0 0 20px rgba(14,165,233,0.3);
    flex-shrink: 0;
  }

  .logo-text {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo-text span { color: var(--accent); }

  .nav {
    padding: 16px 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
  }

  .nav-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 12px 8px 6px;
    text-align: start;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--muted);
    cursor: pointer;
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 400;
    transition: all 0.18s;
    text-align: start;
  }

  .nav-btn:hover { background: var(--subtle); color: var(--text); }

  .nav-btn.active {
    background: var(--accent-glow);
    color: var(--accent2);
    border-color: rgba(14,165,233,0.25);
  }

  .nav-btn .icon {
    width: 18px; height: 18px;
    opacity: 0.7;
    flex-shrink: 0;
  }

  .nav-btn.active .icon { opacity: 1; }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(16,185,129,0.08);
    border: 1px solid rgba(16,185,129,0.2);
    border-radius: 20px;
    font-size: 12px;
    color: var(--green);
    font-family: 'DM Mono', monospace;
  }

  .status-dot {
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
    flex-shrink: 0;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main {
    margin-left: var(--sidebar-w);
    margin-right: 0;
    padding: 32px;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  .page { display: none; animation: fadeIn 0.25s ease; }
  .page.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
  .page-header { margin-bottom: 28px; }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 26px;
    letter-spacing: -0.5px;
  }

  .page-subtitle { color: var(--muted); font-size: 14px; margin-top: 4px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: #2a3f5f; }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title svg { color: var(--accent); flex-shrink: 0; }

  /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 22px;
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
  }

  .stat-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(14,165,233,0.1);
  }

  .stat-card::after {
    content: '';
    position: absolute;
    top: 0; inset-inline-start: 0; inset-inline-end: 0;
    height: 2px;
    background: linear-gradient(to inline-end, var(--accent), transparent);
  }

  /* Fix for RTL gradient direction */
  [dir="rtl"] .stat-card::after {
    background: linear-gradient(to left, var(--accent), transparent);
  }
  [dir="ltr"] .stat-card::after {
    background: linear-gradient(to right, var(--accent), transparent);
  }

  .stat-label {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
  }

  .stat-icon {
    position: absolute;
    top: 18px; inset-inline-end: 18px;
    width: 34px; height: 34px;
    background: var(--accent-glow);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    border: 1px solid rgba(14,165,233,0.15);
  }

  /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
  .form-group { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  input, textarea, select {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-align: start;
    direction: inherit;
  }

  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  input::placeholder, textarea::placeholder { color: var(--muted); }

  textarea { resize: vertical; min-height: 110px; line-height: 1.6; }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 0 20px rgba(14,165,233,0.25);
    border-color: var(--accent);
  }

  .btn-primary:hover {
    background: var(--accent2);
    box-shadow: 0 0 28px rgba(14,165,233,0.4);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--subtle);
    color: var(--text);
    border-color: var(--border);
  }

  .btn-secondary:hover { background: var(--surface2); border-color: #2a3f5f; }

  .btn-danger {
    background: rgba(244,63,94,0.12);
    color: var(--red);
    border-color: rgba(244,63,94,0.25);
  }

  .btn-danger:hover { background: rgba(244,63,94,0.22); border-color: var(--red); }

  .btn-ghost {
    background: transparent;
    color: var(--muted);
  }

  .btn-ghost:hover { background: var(--subtle); color: var(--text); border-color: var(--border); }

  .btn-sm { padding: 7px 13px; font-size: 13px; }

  .btn-success {
    background: rgba(16,185,129,0.12);
    color: var(--green);
    border-color: rgba(16,185,129,0.25);
  }

  .btn-success:hover { background: rgba(16,185,129,0.2); }

  .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }

  /* ‚îÄ‚îÄ SPLIT LAYOUT ‚îÄ‚îÄ */
  .split-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    align-items: start;
  }

  /* ‚îÄ‚îÄ RESTAURANT LIST ‚îÄ‚îÄ */
  .restaurant-list {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .r-list-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .r-list-inner { padding: 8px; max-height: 560px; overflow-y: auto; }
  .r-list-inner::-webkit-scrollbar { width: 4px; }
  .r-list-inner::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .r-item {
    width: 100%;
    padding: 11px 12px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    text-align: start;
    transition: all 0.15s;
    margin-bottom: 2px;
  }

  .r-item:hover { background: var(--subtle); color: var(--text); }

  .r-item.active {
    background: var(--accent-glow);
    border-color: rgba(14,165,233,0.3);
    color: var(--accent2);
  }

  .r-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .r-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .r-dot.off { background: var(--muted); }
  .r-item-name { flex: 1; font-weight: 500; }
  .r-item-actions { display: flex; gap: 6px; }
  .r-mini-btn {
    border: 1px solid var(--border);
    background: var(--subtle);
    color: var(--text);
    padding: 4px 6px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
  }
  .r-mini-btn:hover { border-color: #2a3f5f; }

  /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
  .chat-box {
    height: 200px;
    overflow-y: auto;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-box::-webkit-scrollbar { width: 4px; }
  .chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .chat-msg { display: flex; flex-direction: column; gap: 2px; }

  .chat-msg .sender {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
  }

  .chat-msg.user .sender { color: var(--accent); }
  .chat-msg.ai .sender { color: var(--green); }

  .chat-msg .bubble {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 90%;
  }

  .chat-msg.user { align-items: flex-end; }
  .chat-msg.ai { align-items: flex-start; }

  [dir="rtl"] .chat-msg.user { align-items: flex-start; }
  [dir="rtl"] .chat-msg.ai { align-items: flex-end; }

  .chat-msg.user .bubble {
    background: var(--accent-glow);
    border: 1px solid rgba(14,165,233,0.2);
    color: var(--text);
  }

  .chat-msg.ai .bubble {
    background: var(--subtle);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .chat-input-row { display: flex; gap: 8px; }
  .chat-input-row input { flex: 1; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .data-table { width: 100%; border-collapse: collapse; }

  .data-table thead tr { border-bottom: 1px solid var(--border); }

  .data-table th {
    padding: 10px 14px;
    text-align: start;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 400;
  }

  .data-table td {
    padding: 13px 14px;
    font-size: 13px;
    border-bottom: 1px solid rgba(30,45,69,0.5);
    color: #c4d4e8;
    vertical-align: middle;
  }

  .data-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .data-table tbody tr:last-child td { border-bottom: none; }

  /* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    white-space: nowrap;
  }

  .badge-green { background: rgba(16,185,129,0.12); color: var(--green); border: 1px solid rgba(16,185,129,0.2); }
  .badge-red   { background: rgba(244,63,94,0.12);  color: var(--red);   border: 1px solid rgba(244,63,94,0.2); }
  .badge-amber { background: rgba(245,158,11,0.12); color: var(--amber); border: 1px solid rgba(245,158,11,0.2); }
  .badge-blue  { background: var(--accent-glow);    color: var(--accent2);border: 1px solid rgba(14,165,233,0.2); }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
  .empty-state p { font-size: 14px; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast {
    position: fixed;
    bottom: 24px;
    inset-inline-end: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 9999;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    pointer-events: none;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    max-width: 320px;
  }

  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.success { border-color: rgba(16,185,129,0.4); }
  #toast.success .toast-dot { background: var(--green); }
  #toast.error { border-color: rgba(244,63,94,0.4); }
  #toast.error .toast-dot { background: var(--red); }

  .toast-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: var(--green); }

  /* ‚îÄ‚îÄ VOICE BUTTON ‚îÄ‚îÄ */
  .voice-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 24px;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: var(--radius);
    color: var(--green);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
  }

  .voice-btn:hover {
    background: rgba(16,185,129,0.18);
    border-color: var(--green);
    box-shadow: 0 0 20px rgba(16,185,129,0.15);
  }

  .voice-btn.active { background: rgba(244,63,94,0.1); border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(14,165,233,0.3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ TWILIO ‚îÄ‚îÄ */
  .twilio-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
  }

  /* ‚îÄ‚îÄ LANG SWITCHER ‚îÄ‚îÄ */
  #lang-switcher {
    position: fixed;
    top: 14px;
    inset-inline-end: 14px;
    z-index: 10000;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0;
    overflow: hidden;
    display: flex;
  }

  .lang-opt {
    padding: 7px 13px;
    background: transparent;
    border: none;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .lang-opt:hover { background: var(--subtle); color: var(--text); }
  .lang-opt.active { background: var(--accent-glow); color: var(--accent2); }

  .lang-divider { width: 1px; background: var(--border); flex-shrink: 0; }

  /* ‚îÄ‚îÄ RTL-SPECIFIC FIXES ‚îÄ‚îÄ */
  /* Sidebar stays on the left in both LTR and RTL */
  [dir="rtl"] .sidebar {
    left: 0;
    right: auto;
  }

  [dir="ltr"] .sidebar {
    left: 0;
    right: auto;
  }

  /* Card-title badge push */
  .card-title .badge-ml { margin-inline-start: auto; }

  /* AUTH */
  .auth-modal {
    position: fixed;
    inset: 0;
    background: rgba(8,12,20,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
  }

  .auth-hidden { display: none; }

  .auth-card {
    width: min(380px, 92vw);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 26px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.45);
  }

  .auth-title {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .auth-subtitle {
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 16px;
  }

  .auth-error {
    color: var(--red);
    font-size: 12px;
    margin-top: 8px;
    min-height: 16px;
  }

  .edit-modal-card {
    width: min(440px, 92vw);
  }

  .edit-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 4px;
  }
</style>
</head>
<body dir="ltr">

<!-- Language Switcher -->
<div id="lang-switcher">
  <button class="lang-opt active" onclick="setLang('en')">EN</button>
  <div class="lang-divider"></div>
  <button class="lang-opt" onclick="setLang('he')">◊¢◊ë</button>
</div>

<!-- Auth Modal -->
<div id="authModal" class="auth-modal auth-hidden">
  <div class="auth-card">
    <div class="auth-title" data-i18n="Sign in">Sign in</div>
    <div class="auth-subtitle" data-i18n="Sign in to continue">Sign in to continue</div>
    <div class="form-group">
      <label class="form-label" data-i18n="Email">Email</label>
      <input id="authEmail" type="email" placeholder="admin@example.com">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="Password">Password</label>
      <input id="authPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-primary" onclick="login()" data-i18n="Sign in">Sign in</button>
    <div id="authError" class="auth-error"></div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="auth-modal auth-hidden">
  <div class="auth-card edit-modal-card">
    <div class="auth-title" data-i18n="Edit User">Edit User</div>
    <div class="auth-subtitle" data-i18n="Update email and password for this user">Update email and password for this user</div>
    <div class="form-group">
      <label class="form-label" data-i18n="Admin Email">Admin Email</label>
      <input id="editUserEmail" type="email" placeholder="manager@example.com">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="New Password (optional)">New Password (optional)</label>
      <input id="editUserPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div id="editUserError" class="auth-error"></div>
    <div class="edit-modal-actions">
      <button class="btn btn-secondary btn-sm" onclick="closeEditUserModal()" data-i18n="Cancel">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveEditedUser()" data-i18n="Save Changes">Save Changes</button>
    </div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-icon">üéôÔ∏è</div>
    <div class="logo-text">Voice<span>IQ</span></div>
  </div>

  <div class="nav">
    <div class="nav-label" data-i18n="Platform">Platform</div>
    <button class="nav-btn active" onclick="show('dash',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span data-i18n="Dashboard">Dashboard</span>
    </button>
    <button id="nav-global" class="nav-btn" onclick="show('global',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      <span data-i18n="Global Prompt">Global Prompt</span>
    </button>
    <button id="nav-restaurants" class="nav-btn" onclick="show('restaurants',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
      <span data-i18n="Restaurants">Restaurants</span>
    </button>
    <button class="nav-btn" onclick="show('orders',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/>
        <line x1="12" y1="22" x2="12" y2="12"/>
      </svg>
      <span data-i18n="Orders">Orders</span>
    </button>
    <button class="nav-btn" onclick="show('logs',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <span data-i18n="Call Logs">Call Logs</span>
    </button>
  </div>

  <div class="sidebar-footer">
    <div class="status-pill">
      <div class="status-dot"></div>
      <span data-i18n="System Online">System Online</span>
    </div>
    <button class="btn btn-ghost btn-sm" style="margin-top:10px;width:100%" onclick="logout()" data-i18n="Logout">Logout</button>
  </div>
</nav>

<!-- Main content -->
<main class="main">

  <!-- Dashboard -->
  <div id="dash" class="page active">
    <div class="page-header">
      <div class="page-title" data-i18n="Dashboard">Dashboard</div>
      <div class="page-subtitle" data-i18n="Platform performance overview">Platform performance overview</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label" data-i18n="Active Restaurants">Active Restaurants</div>
        <div class="stat-value" id="s-restaurants">‚Äî</div>
        <div class="stat-icon">üçΩÔ∏è</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Total Calls">Total Calls</div>
        <div class="stat-value" id="s-calls">‚Äî</div>
        <div class="stat-icon">üìû</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Missed Calls">Missed Calls</div>
        <div class="stat-value" id="s-missed">‚Äî</div>
        <div class="stat-icon">üìµ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Total Duration">Total Duration</div>
        <div class="stat-value" id="s-duration">‚Äî</div>
        <div class="stat-icon">‚è±Ô∏è</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="API Usage">API Usage</div>
        <div class="stat-value" id="s-usage">0</div>
        <div class="stat-icon">üîå</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Usage Cost">Usage Cost</div>
        <div class="stat-value" id="s-cost">$0.00</div>
        <div class="stat-icon">üí≥</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        <span data-i18n="Recent Activity">Recent Activity</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th data-i18n="Restaurant">Restaurant</th>
            <th data-i18n="Caller">Caller</th>
            <th data-i18n="Status">Status</th>
            <th data-i18n="Duration">Duration</th>
            <th data-i18n="Date">Date</th>
          </tr>
        </thead>
        <tbody id="recentLogs">
          <tr><td colspan="5"><div class="empty-state"><div class="empty-icon">üìã</div><p data-i18n="No recent calls">No recent calls</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Global Prompt -->
  <div id="global" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Global Prompt">Global Prompt</div>
      <div class="page-subtitle" data-i18n="global-sub">This prompt is injected into every restaurant's AI context</div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        <span data-i18n="Base System Prompt">Base System Prompt</span>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="Prompt Content">Prompt Content</label>
        <textarea id="globalPrompt" style="min-height:180px"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="saveGlobal()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          <span data-i18n="Save Changes">Save Changes</span>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span data-i18n="Tips">Tips</span>
      </div>
      <p style="font-size:13px;color:var(--muted);line-height:1.7" data-i18n="global-tip">
        The global prompt sets the baseline behavior for all restaurants. Each restaurant's individual prompt is appended after this, allowing per-restaurant customization.
      </p>
    </div>
  </div>

  <!-- Restaurants -->
  <div id="restaurants" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Restaurants">Restaurants</div>
      <div class="page-subtitle" data-i18n="Manage connected restaurant profiles">Manage connected restaurant profiles</div>
    </div>

    <div class="split-layout">
      <div class="restaurant-list">
        <div class="r-list-header">
          <span data-i18n="Restaurant List">Restaurant List</span>
          <button id="createBtn" class="btn btn-ghost btn-sm" onclick="toggleCreate()" title="Add new">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <div class="r-list-inner" id="rlist">
          <div class="empty-state" style="padding:30px 16px">
            <div class="empty-icon" style="font-size:28px">üçΩÔ∏è</div>
            <p data-i18n="No restaurants yet">No restaurants yet</p>
          </div>
        </div>
      </div>

      <div id="rightPane">
        <div id="createBox" class="card" style="display:none">
          <div class="card-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span data-i18n="Create Restaurant">Create Restaurant</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" data-i18n="Restaurant Name">Restaurant Name</label>
              <input id="rname" data-placeholder-i18n="e.g. Bella Italia">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="Phone Number">Phone Number</label>
              <input id="rphone" placeholder="+1 (555) 000-0000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="IVR Prompt">IVR Prompt</label>
            <textarea id="rprompt"></textarea>
          </div>
          <div class="actions">
            <button class="btn btn-primary" onclick="addRestaurant()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              <span data-i18n="Create Restaurant">Create Restaurant</span>
            </button>
          </div>
        </div>

        <div id="assignBox" class="card" style="display:none">
          <div class="card-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
            <span data-i18n="Assign Admin">Assign Admin</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" data-i18n="Admin Email">Admin Email</label>
              <input id="adminEmail" placeholder="manager@example.com">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="Temp Password">Temp Password</label>
              <input id="adminPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="Restaurant">Restaurant</label>
            <select id="adminRestaurant"></select>
          </div>
          <div class="actions">
            <button class="btn btn-primary" onclick="createOrAssignAdmin()">
              <span data-i18n="Create/Assign">Create/Assign</span>
            </button>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:8px" data-i18n="Assign Admin Help">
            If user exists, we only assign. If not, we create with password.
          </div>
        </div>

        <div id="rdetail">
          <div class="card" style="text-align:center; padding:60px 20px">
            <div style="font-size:40px;margin-bottom:12px;opacity:0.25">üëÜ</div>
            <div style="color:var(--muted);font-size:14px" data-i18n="Select a restaurant to manage it">Select a restaurant to manage it</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div id="orders" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Orders">Orders</div>
      <div class="page-subtitle" data-i18n="Structured orders captured from calls">Structured orders captured from calls</div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          <polyline points="3.29 7 12 12 20.71 7"/>
          <line x1="12" y1="22" x2="12" y2="12"/>
        </svg>
        <span data-i18n="All Orders">All Orders</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-i18n="Restaurant">Restaurant</th>
            <th data-i18n="Customer">Customer</th>
            <th data-i18n="Order Type">Order Type</th>
            <th data-i18n="Arrival Date">Arrival Date</th>
            <th data-i18n="Arrival Time">Arrival Time</th>
            <th data-i18n="Total People">Total People</th>
            <th data-i18n="Contact Number">Contact Number</th>
            <th data-i18n="Status">Status</th>
            <th data-i18n="Date">Date</th>
          </tr>
        </thead>
        <tbody id="orderTable">
          <tr><td colspan="10"><div class="empty-state"><div class="empty-icon">#</div><p data-i18n="No orders recorded yet">No orders recorded yet</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Call Logs -->
  <div id="logs" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Call Logs">Call Logs</div>
      <div class="page-subtitle" data-i18n="Full history of all IVR interactions">Full history of all IVR interactions</div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.6 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6a16 16 0 0 0 6.29 6.29l.96-.96a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        <span data-i18n="All Calls">All Calls</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-i18n="Restaurant">Restaurant</th>
            <th data-i18n="Caller">Caller</th>
            <th data-i18n="Status">Status</th>
            <th data-i18n="Duration">Duration</th>
            <th data-i18n="Date">Date</th>
          </tr>
        </thead>
        <tbody id="logTable">
          <tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üìµ</div><p data-i18n="No calls recorded yet">No calls recorded yet</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<!-- Toast -->
<div id="toast">
  <div class="toast-dot"></div>
  <span id="toastMsg"></span>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ I18N ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TRANSLATIONS = {
  en: {
    "Twilio guide": "To integrate this agent with your Twilio number: go to Twilio Console -> Phone Numbers -> Active Numbers -> select your number -> Voice Configuration -> A Call Comes In -> choose Webhook, paste this URL, and save using HTTP POST.",
    "Sign in": "Sign in",
    "Sign in to continue": "Sign in to continue",
    "Email": "Email",
    "Password": "Password",
    "Logout": "Logout",
    "Invalid credentials": "Invalid credentials",
    "Logged out": "Logged out",
    "Assign Admin": "Assign Admin",
    "Admin Email": "Admin Email",
    "Temp Password": "Temp Password",
    "Create/Assign": "Create/Assign",
    "Assign Admin Help": "If user exists, we only assign. If not, we create with password.",
    "Admin assigned": "Admin assigned",
    "Admins for this restaurant": "Admins for this restaurant",
    "No admins assigned": "No admins assigned",
    "Edit User": "Edit User",
    "Delete User": "Delete User",
    "Enter new email": "Enter new email",
    "Enter new password (leave empty to keep current)": "Enter new password (leave empty to keep current)",
    "User updated": "User updated",
    "User deleted": "User deleted",
    "Delete this user? This cannot be undone.": "Delete this user? This cannot be undone.",
    "Update email and password for this user": "Update email and password for this user",
    "New Password (optional)": "New Password (optional)",
    "Cancel": "Cancel",
    "Revoke Access": "Revoke Access",
    "Restore Access": "Restore Access",
    "Loading...": "Loading...",
    "Orders": "Orders",
    "All Orders": "All Orders",
    "Structured orders captured from calls": "Structured orders captured from calls",
    "Customer": "Customer",
    "Order Type": "Order Type",
    "Arrival Date": "Arrival Date",
    "Arrival Time": "Arrival Time",
    "Total People": "Total People",
    "Contact Number": "Contact Number",
    "Address": "Address",
    "Items": "Items",
    "Payment": "Payment",
    "No orders recorded yet": "No orders recorded yet",
    "Order captured": "Order captured",
    "Order capture failed": "Order capture failed"
  },
  he: {
    "Platform": "◊§◊ú◊ò◊§◊ï◊®◊û◊î",
    "Dashboard": "◊ú◊ï◊ó ◊ë◊ß◊®◊î",
    "Global Prompt": "◊§◊®◊ï◊û◊§◊ò ◊í◊ú◊ï◊ë◊ú◊ô",
    "Restaurants": "◊û◊°◊¢◊ì◊ï◊™",
    "Call Logs": "◊ô◊ï◊û◊†◊ô ◊©◊ô◊ó◊ï◊™",
    "System Online": "◊î◊û◊¢◊®◊õ◊™ ◊§◊¢◊ô◊ú◊î",
    "Platform performance overview": "◊°◊ß◊ô◊®◊™ ◊ë◊ô◊¶◊ï◊¢◊ô ◊î◊§◊ú◊ò◊§◊ï◊®◊û◊î",
    "Active Restaurants": "◊û◊°◊¢◊ì◊ï◊™ ◊§◊¢◊ô◊ú◊ï◊™",
    "Total Calls": "◊°◊î◊¥◊õ ◊©◊ô◊ó◊ï◊™",
    "Missed Calls": "◊©◊ô◊ó◊ï◊™ ◊©◊ú◊ê ◊†◊¢◊†◊ï",
    "Avg Duration": "◊û◊©◊ö ◊û◊û◊ï◊¶◊¢",
    "API Usage": "◊©◊ô◊û◊ï◊© ◊ë-API",
    "Usage Cost": "◊¢◊ú◊ï◊™ ◊©◊ô◊û◊ï◊©",
    "Recent Activity": "◊§◊¢◊ô◊ú◊ï◊™ ◊ê◊ó◊®◊ï◊†◊î",
    "Restaurant": "◊û◊°◊¢◊ì◊î",
    "Caller": "◊û◊™◊ß◊©◊®",
    "Status": "◊°◊ò◊ò◊ï◊°",
    "Duration": "◊û◊©◊ö",
    "Date": "◊™◊ê◊®◊ô◊ö",
    "No recent calls": "◊ê◊ô◊ü ◊©◊ô◊ó◊ï◊™ ◊ê◊ó◊®◊ï◊†◊ï◊™",
    "Base System Prompt": "◊§◊®◊ï◊û◊§◊ò ◊û◊¢◊®◊õ◊™ ◊ë◊°◊ô◊°◊ô",
    "Prompt Content": "◊™◊ï◊õ◊ü ◊î◊§◊®◊ï◊û◊§◊ò",
    "Save Changes": "◊©◊û◊ï◊® ◊©◊ô◊†◊ï◊ô◊ô◊ù",
    "Tips": "◊ò◊ô◊§◊ô◊ù",
    "global-sub": "◊§◊®◊ï◊û◊§◊ò ◊ñ◊î ◊û◊ï◊ñ◊®◊ß ◊ú◊õ◊ú ◊î◊ß◊©◊® ◊î-AI ◊©◊ú ◊î◊û◊°◊¢◊ì◊î",
    "global-tip": "◊î◊§◊®◊ï◊û◊§◊ò ◊î◊í◊ú◊ï◊ë◊ú◊ô ◊ß◊ï◊ë◊¢ ◊ê◊™ ◊î◊î◊™◊†◊î◊í◊ï◊™ ◊î◊ë◊°◊ô◊°◊ô◊™ ◊ú◊õ◊ú ◊î◊û◊°◊¢◊ì◊ï◊™. ◊î◊§◊®◊ï◊û◊§◊ò ◊©◊ú ◊õ◊ú ◊û◊°◊¢◊ì◊î ◊û◊¶◊ï◊®◊£ ◊ê◊ó◊®◊ô◊ï.",
    "Restaurant List": "◊®◊©◊ô◊û◊™ ◊û◊°◊¢◊ì◊ï◊™",
    "No restaurants yet": "◊ê◊ô◊ü ◊¢◊ì◊ô◊ô◊ü ◊û◊°◊¢◊ì◊ï◊™",
    "Create Restaurant": "◊ô◊¶◊ô◊®◊™ ◊û◊°◊¢◊ì◊î",
    "Restaurant Name": "◊©◊ù ◊î◊û◊°◊¢◊ì◊î",
    "Phone Number": "◊û◊°◊§◊® ◊ò◊ú◊§◊ï◊ü",
    "IVR Prompt": "◊§◊®◊ï◊û◊§◊ò IVR",
    "Select a restaurant to manage it": "◊ë◊ó◊® ◊û◊°◊¢◊ì◊î ◊õ◊ì◊ô ◊ú◊†◊î◊ú ◊ê◊ï◊™◊î",
    "Manage connected restaurant profiles": "◊†◊ô◊î◊ï◊ú ◊§◊®◊ï◊§◊ô◊ú◊ô ◊û◊°◊¢◊ì◊ï◊™ ◊û◊ó◊ï◊ë◊®◊ï◊™",
    "All Calls": "◊õ◊ú ◊î◊©◊ô◊ó◊ï◊™",
    "Full history of all IVR interactions": "◊î◊ô◊°◊ò◊ï◊®◊ô◊î ◊û◊ú◊ê◊î ◊©◊ú ◊õ◊ú ◊ê◊ô◊†◊ò◊®◊ê◊ß◊¶◊ô◊ï◊™ ◊î-IVR",
    "No calls recorded yet": "◊¢◊ì◊ô◊ô◊ü ◊ú◊ê ◊†◊®◊©◊û◊ï ◊©◊ô◊ó◊ï◊™",
    "Name": "◊©◊ù",
    "Phone": "◊ò◊ú◊§◊ï◊ü",
    "Save": "◊©◊û◊ï◊®",
    "Delete": "◊û◊ó◊ß",
    "Active": "◊§◊¢◊ô◊ú",
    "Inactive": "◊ú◊ê ◊§◊¢◊ô◊ú",
    "Text Chat": "◊¶'◊ê◊ò ◊ò◊ß◊°◊ò",
    "Voice Chat": "◊¶'◊ê◊ò ◊ß◊ï◊ú◊ô",
    "Voice Chat desc": "◊î◊™◊ó◊ú ◊©◊ô◊ó◊î ◊ß◊ï◊ú◊ô◊™ ◊ë◊ñ◊û◊ü ◊ê◊û◊™ ◊¢◊ù ◊î◊¢◊ï◊ñ◊®.",
    "Start Voice Session": "◊î◊™◊ó◊ú ◊©◊ô◊ó◊î ◊ß◊ï◊ú◊ô◊™",
    "End Voice Session": "◊°◊ô◊ô◊ù ◊©◊ô◊ó◊î ◊ß◊ï◊ú◊ô◊™",
    "Twilio Webhook": "◊ï◊ï◊ë◊î◊ï◊ß Twilio",
    "Twilio guide": "◊õ◊ì◊ô ◊ú◊ó◊ë◊® ◊ê◊™ ◊î◊°◊ï◊õ◊ü ◊î◊ñ◊î ◊ú◊û◊°◊§◊® ◊î-Twilio ◊©◊ú◊ö: ◊¢◊ë◊ï◊® ◊ú-Twilio Console ‚Üê Phone Numbers ‚Üê Active Numbers ‚Üê ◊ë◊ó◊® ◊ê◊™ ◊î◊û◊°◊§◊® ‚Üê Voice Configuration ‚Üê A Call Comes In ‚Üê ◊ë◊ó◊® Webhook, ◊î◊ì◊ë◊ß ◊ê◊™ ◊î-URL ◊î◊ñ◊î ◊ï◊©◊û◊ï◊® ◊ë◊ê◊û◊¶◊¢◊ï◊™ HTTP POST.",
    "Public Base URL (ngrok/hosted)": "◊õ◊™◊ï◊ë◊™ ◊ë◊°◊ô◊° ◊¶◊ô◊ë◊ï◊®◊ô◊™ (ngrok/hosted)",
    "Twilio Webhook URL": "◊õ◊™◊ï◊ë◊™ Webhook ◊©◊ú Twilio",
    "Copy": "◊î◊¢◊™◊ß",
    "You": "◊ê◊™◊î",
    "AI": "AI",
    "Deactivate": "◊î◊©◊ë◊™",
    "Activate": "◊î◊§◊¢◊ú",
    // toasts
    "Global prompt saved successfully": "◊î◊§◊®◊ï◊û◊§◊ò ◊î◊í◊ú◊ï◊ë◊ú◊ô ◊†◊©◊û◊®",
    "Failed to save": "◊î◊©◊û◊ô◊®◊î ◊†◊õ◊©◊ú◊î",
    "Restaurant name is required": "◊©◊ù ◊û◊°◊¢◊ì◊î ◊î◊ï◊ê ◊©◊ì◊î ◊ó◊ï◊ë◊î",
    "Failed to add restaurant": "◊î◊ï◊°◊§◊™ ◊î◊û◊°◊¢◊ì◊î ◊†◊õ◊©◊ú◊î",
    "Restaurant updated": "◊î◊û◊°◊¢◊ì◊î ◊¢◊ï◊ì◊õ◊†◊î",
    "Update failed": "◊î◊¢◊ì◊õ◊ï◊ü ◊†◊õ◊©◊ú",
    "Status updated": "◊î◊°◊ò◊ò◊ï◊° ◊¢◊ï◊ì◊õ◊ü",
    "Failed": "◊†◊õ◊©◊ú",
    "Restaurant deleted": "◊î◊û◊°◊¢◊ì◊î ◊†◊û◊ó◊ß◊î",
    "Delete failed": "◊î◊û◊ó◊ô◊ß◊î ◊†◊õ◊©◊ú◊î",
    "Select a restaurant first": "◊ë◊ó◊® ◊û◊°◊¢◊ì◊î ◊ß◊ï◊ì◊ù",
    "Server error, we will fix soon.": "◊©◊í◊ô◊ê◊™ ◊©◊®◊™, ◊†◊ò◊§◊ú ◊ë◊ñ◊î ◊ë◊ß◊®◊ï◊ë.",
    "Connection error": "◊©◊í◊ô◊ê◊™ ◊ó◊ô◊ë◊ï◊®",
    "Voice session started": "◊î◊©◊ô◊ó◊î ◊î◊ß◊ï◊ú◊ô◊™ ◊î◊™◊ó◊ô◊ú◊î",
    "Voice session error": "◊©◊í◊ô◊ê◊™ ◊©◊ô◊ó◊î ◊ß◊ï◊ú◊ô◊™",
    "Voice requires HTTPS": "◊©◊ô◊ó◊î ◊ß◊ï◊ú◊ô◊™ ◊ì◊ï◊®◊©◊™ HTTPS ◊¢◊ù ◊í◊ô◊©◊™ ◊û◊ô◊ß◊®◊ï◊§◊ï◊ü",
    "Twilio URL copied": "◊õ◊™◊ï◊ë◊™ Twilio ◊î◊ï◊¢◊™◊ß◊î",
    "Copy failed": "◊î◊î◊¢◊™◊ß◊î ◊†◊õ◊©◊ú◊î",
    "Delete this restaurant? This cannot be undone.": "◊ú◊û◊ó◊ï◊ß ◊ê◊™ ◊î◊û◊°◊¢◊ì◊î? ◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊ë◊ò◊ú.",
    "Assign Admin": "◊î◊ß◊¶◊ê◊™ ◊û◊†◊î◊ú",
    "Admin Email": "◊ê◊ô◊û◊ô◊ô◊ú ◊û◊†◊î◊ú",
    "Temp Password": "◊°◊ô◊°◊û◊î ◊ñ◊û◊†◊ô◊™",
    "Create/Assign": "◊¶◊ï◊®/◊©◊ô◊ô◊ö",
    "Assign Admin Help": "◊ê◊ù ◊î◊û◊©◊™◊û◊© ◊ß◊ô◊ô◊ù ◊†◊©◊ô◊ô◊ö ◊ë◊ú◊ë◊ì. ◊ê◊ù ◊ú◊ê, ◊†◊ô◊¶◊ï◊® ◊¢◊ù ◊°◊ô◊°◊û◊î.",
    "Admin assigned": "◊û◊†◊î◊ú ◊©◊ï◊ô◊ö",
    "Admins for this restaurant": "◊û◊†◊î◊ú◊ô◊ù ◊ú◊û◊°◊¢◊ì◊î ◊ñ◊ï",
    "No admins assigned": "◊ê◊ô◊ü ◊û◊†◊î◊ú◊ô◊ù ◊û◊©◊ï◊ô◊õ◊ô◊ù",
    "Revoke Access": "◊ë◊ò◊ú ◊í◊ô◊©◊î",
    "Restore Access": "◊©◊ó◊ñ◊® ◊í◊ô◊©◊î",
    "Loading...": "◊ò◊ï◊¢◊ü..."
  }
};

let currentLang = localStorage.getItem('ui_lang') || 'en';

function t(key) {
  if (currentLang === 'en') return (TRANSLATIONS.en && TRANSLATIONS.en[key]) || key;
  return (TRANSLATIONS.he && TRANSLATIONS.he[key]) || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('ui_lang', lang);

  // Update html dir + lang
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
  document.body.dir = lang === 'he' ? 'rtl' : 'ltr';

  // Lang switcher buttons
  document.querySelectorAll('.lang-opt').forEach(b => {
    b.classList.toggle('active', b.textContent.trim() === (lang === 'en' ? 'EN' : '◊¢◊ë'));
  });

  // Translate all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const translated = t(key);
    if (translated !== key || lang === 'en') {
      el.textContent = translated;
    }
  });

  // Translate placeholders
  document.querySelectorAll('[data-placeholder-i18n]').forEach(el => {
    const key = el.getAttribute('data-placeholder-i18n');
    el.placeholder = t(key);
  });

  // Re-render restaurant detail if open (to translate dynamic content)
  if (selectedId) openRestaurant(selectedId, true);
}

// ‚îÄ‚îÄ‚îÄ CORE APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_BASE = (() => {
  const isLocalStaticFrontend =
    (window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1" ||
      window.location.hostname === "::1") &&
    window.location.port === "8000";

  const apiOrigin = isLocalStaticFrontend
    ? window.location.origin.replace(":8000", ":5050")
    : window.location.origin;

  return isLocalStaticFrontend ? apiOrigin : `${apiOrigin}/api`;
})();
const authState = {
  token: localStorage.getItem('auth_token') || ''
};

let initialized = false;
let currentUser = null;
let usersCache = [];
let editingUserId = null;

function setAuthToken(token) {
  authState.token = token || '';
  if (authState.token) {
    localStorage.setItem('auth_token', authState.token);
  } else {
    localStorage.removeItem('auth_token');
  }
}

function showLogin(message) {
  const modal = document.getElementById('authModal');
  const err = document.getElementById('authError');
  err.textContent = message || '';
  modal.classList.remove('auth-hidden');
}

function hideLogin() {
  const modal = document.getElementById('authModal');
  const err = document.getElementById('authError');
  err.textContent = '';
  modal.classList.add('auth-hidden');
}

function closeEditUserModal() {
  const modal = document.getElementById('editUserModal');
  const err = document.getElementById('editUserError');
  const email = document.getElementById('editUserEmail');
  const password = document.getElementById('editUserPassword');
  if (err) err.textContent = '';
  if (email) email.value = '';
  if (password) password.value = '';
  editingUserId = null;
  modal?.classList.add('auth-hidden');
}

async function apiFetch(url, options = {}) {
  const headers = { ...(options.headers || {}) };
  if (authState.token) headers.Authorization = `Bearer ${authState.token}`;
  const res = await fetch(url, { ...options, headers });
  if (res.status === 401) {
    setAuthToken('');
    showLogin(t('Sign in to continue'));
    throw new Error('Unauthorized');
  }
  return res;
}

async function login() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value;
  const err = document.getElementById('authError');
  err.textContent = '';
  if (!email || !password) {
    err.textContent = t('Invalid credentials');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok || !data.token) throw new Error('auth failed');
    setAuthToken(data.token);
    hideLogin();
    await initAfterAuth();
  } catch (e) {
    err.textContent = t('Invalid credentials');
  }
}

document.getElementById('authPassword')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') login();
});

document.getElementById('editUserPassword')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') saveEditedUser();
});

document.getElementById('editUserModal')?.addEventListener('click', (e) => {
  if (e.target?.id === 'editUserModal') closeEditUserModal();
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeEditUserModal();
});

async function logout() {
  try {
    if (authState.token) {
      await apiFetch(`${API_BASE}/auth/logout`, { method: 'POST' });
    }
  } catch (e) {}
  setAuthToken('');
  showLogin(t('Logged out'));
}

async function checkAuth() {
  if (!authState.token) {
    showLogin();
    return false;
  }
  try {
    const me = await (await apiFetch(`${API_BASE}/auth/me`)).json();
    currentUser = me;
    applyRoleUI();
    hideLogin();
    return true;
  } catch (e) {
    showLogin(t('Sign in to continue'));
    return false;
  }
}

async function loadMe() {
  try {
    const me = await (await apiFetch(`${API_BASE}/auth/me`)).json();
    currentUser = me;
    applyRoleUI();
  } catch (e) {}
}

function applyRoleUI() {
  const isAdmin = !!currentUser?.is_admin;
  const navGlobal = document.getElementById('nav-global');
  if (navGlobal) navGlobal.style.display = isAdmin ? '' : 'none';
  const assignBox = document.getElementById('assignBox');
  if (assignBox) assignBox.style.display = (isAdmin && assignBoxOpenedByIcon) ? 'block' : 'none';
  const createBox = document.getElementById('createBox');
  if (createBox && !isAdmin) createBox.style.display = 'none';
  const createBtn = document.getElementById('createBtn');
  if (createBtn) createBtn.style.display = isAdmin ? '' : 'none';
  if (!isAdmin) {
    const btns = document.querySelectorAll('.nav-btn');
    btns.forEach(b => {
      if (b.id === 'nav-global') return;
    });
  }
}

async function initAfterAuth() {
  if (initialized) return;
  initialized = true;
  await loadMe();
  loadGlobal();
  loadRestaurants();
  loadStats();
  loadLogs();
}
let restaurantsCache = [];
let selectedId = null;
let assignBoxOpenedByIcon = false;
let assignBoxRestaurantId = null;
const ORDER_JSON_MARKER = "ORDER_JSON:";
let orderCapture = { buffer: "", markerTail: "", saved: false };
let voiceSession = {
  pc: null,
  localStream: null,
  audioEl: null,
  dc: null,
  active: false
};

function show(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (id === 'logs') loadLogs();
  if (id === 'orders') loadOrders();
  if (id === 'restaurants') loadRestaurants();
}

let toastTimer;
function toast(msg, type = 'success') {
  clearTimeout(toastTimer);
  const el = document.getElementById('toast');
  el.className = `show ${type}`;
  document.getElementById('toastMsg').textContent = t(msg);
  toastTimer = setTimeout(() => { el.className = ''; }, 3200);
}

function esc(v) {
  return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function normalizeUrl(url) {
  return String(url || '').trim().replace(/\/+$/, '');
}

function sanitizeTwilioBaseUrl(url) {
  let cleaned = normalizeUrl(url);
  cleaned = cleaned.replace(/\/incoming-call(?:\/\d+)?(?:\?.*)?$/i, '');
  return cleaned;
}

function getPublicBaseUrl() {
  return sanitizeTwilioBaseUrl(localStorage.getItem('twilioBaseUrl') || '');
}

function setPublicBaseUrl(url) {
  localStorage.setItem('twilioBaseUrl', sanitizeTwilioBaseUrl(url));
}

function getTwilioBaseUrl() {
  return sanitizeTwilioBaseUrl(getPublicBaseUrl() || API_BASE);
}

function buildTwilioUrl(id) {
  const base = getTwilioBaseUrl();
  return `${base}/incoming-call/${id}`;
}

function toggleCreate() {
  const box = document.getElementById('createBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
}

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadGlobal() {
  try {
    const r = await apiFetch(`${API_BASE}/prompt/`);
    const d = await r.json();
    document.getElementById('globalPrompt').value = d.prompt || '';
  } catch(e) {}
}

async function saveGlobal() {
  try {
    await apiFetch(`${API_BASE}/prompt/save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: document.getElementById('globalPrompt').value })
    });
    toast('Global prompt saved successfully');
  } catch(e) { toast('Failed to save', 'error'); }
}

function formatDuration(value) {
  const totalSeconds = Math.max(0, Math.round(Number(value) || 0));
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  if (hours > 0) return `${hours}h ${minutes}m ${seconds}s`;
  if (minutes > 0) return `${minutes}m ${seconds}s`;
  return `${seconds}s`;
}

async function loadStats() {
  try {
    const s = await (await apiFetch(`${API_BASE}/dashboard/stats`)).json();
    document.getElementById('s-restaurants').textContent = s.restaurants ?? 0;
    document.getElementById('s-calls').textContent = s.calls ?? 0;
    document.getElementById('s-missed').textContent = s.missed ?? 0;
    const totalDuration = s.total_duration ?? 0;
    document.getElementById('s-duration').textContent = formatDuration(totalDuration);
  } catch(e) {}
}

function statusBadge(s) {
  if (!s) return `<span class="badge badge-amber">${t('Unknown')}</span>`;
  const sl = s.toLowerCase();
  if (sl.includes('answer') || sl.includes('complet')) return `<span class="badge badge-green">${esc(s)}</span>`;
  if (sl.includes('miss') || sl.includes('fail')) return `<span class="badge badge-red">${esc(s)}</span>`;
  return `<span class="badge badge-blue">${esc(s)}</span>`;
}

function resetOrderCapture() {
  orderCapture = { buffer: "", markerTail: "", saved: false };
}

function cleanOrderField(value) {
  if (value === null || value === undefined) return '';
  const text = String(value).trim();
  if (!text) return '';
  const lc = text.toLowerCase();
  if (['none','null','n/a','na','unknown'].includes(lc)) return '';
  return text;
}

function firstOrderValue(obj, keys) {
  for (const k of keys) {
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
  }
  return null;
}

function normalizeOrderPayloadClient(data) {
  if (!data || typeof data !== 'object') {
    return { data: {}, missing: ['full_name','date-arrival','time_arrival','total_peoples','contact_number'] };
  }
  const fullName = cleanOrderField(firstOrderValue(data, ['full_name','fullName','name','customer_name','customerName']));
  const dateArrival = cleanOrderField(firstOrderValue(data, ['date-arrival','date_arrival','arrival_date','dateArrival']));
  const timeArrival = cleanOrderField(firstOrderValue(data, ['time_arrival','arrival_time','timeArrival','time']));
  const contactNumber = cleanOrderField(firstOrderValue(data, ['contact_number','contactNumber','phone','phone_number']));
  const totalRaw = firstOrderValue(data, ['total_peoples','total_people','people','party_size']);
  const totalDigits = cleanOrderField(totalRaw).replace(/\D/g, '');
  const totalPeoples = totalDigits ? Number(totalDigits) : (Number.isInteger(totalRaw) ? totalRaw : 0);

  const missing = [];
  if (!fullName) missing.push('full_name');
  if (!dateArrival) missing.push('date-arrival');
  if (!timeArrival) missing.push('time_arrival');
  if (!totalPeoples || totalPeoples <= 0) missing.push('total_peoples');
  if (!contactNumber) missing.push('contact_number');

  return {
    data: {
      order_type: 'reservation',
      full_name: fullName,
      'date-arrival': dateArrival,
      time_arrival: timeArrival,
      total_peoples: totalPeoples,
      contact_number: contactNumber
    },
    missing
  };
}

function extractTextCandidates(evt) {
  if (!evt || typeof evt !== 'object') return [];
  const type = String(evt.type || '');
  if (type === 'response.output_audio.delta' || type === 'response.audio.delta') return [];
  const texts = [];
  ['delta','text','transcript'].forEach(k => {
    const v = evt[k];
    if (typeof v === 'string' && v) texts.push(v);
  });
  ['item','response'].forEach(k => {
    const nested = evt[k];
    if (!nested || typeof nested !== 'object') return;
    ['text','transcript'].forEach(nk => {
      const v = nested[nk];
      if (typeof v === 'string' && v) texts.push(v);
    });
    const content = nested.content;
    if (Array.isArray(content)) {
      content.forEach(part => {
        if (!part || typeof part !== 'object') return;
        ['text','transcript'].forEach(ck => {
          const v = part[ck];
          if (typeof v === 'string' && v) texts.push(v);
        });
      });
    }
  });
  return texts;
}

function parseOrderJsonFromBuffer(buffer) {
  if (!buffer) return null;
  const markerIdx = buffer.indexOf(ORDER_JSON_MARKER);
  if (markerIdx < 0) return null;
  let tail = buffer.slice(markerIdx + ORDER_JSON_MARKER.length).trimStart();
  if (tail.startsWith('```')) {
    const fenceEnd = tail.indexOf('\n');
    if (fenceEnd !== -1) tail = tail.slice(fenceEnd + 1);
  }
  const start = tail.indexOf('{');
  if (start < 0) return null;
  let depth = 0;
  let end = -1;
  for (let i = start; i < tail.length; i++) {
    const ch = tail[i];
    if (ch === '{') depth++;
    else if (ch === '}') {
      depth--;
      if (depth === 0) { end = i; break; }
    }
  }
  if (end < 0) return null;
  const jsonStr = tail.slice(start, end + 1);
  try {
    const data = JSON.parse(jsonStr);
    if (!data || typeof data !== 'object') return null;
    return { raw: jsonStr, data };
  } catch {
    return null;
  }
}

async function ingestOrder(data, raw) {
  if (!selectedId) return;
  const payload = {
    restaurant_id: selectedId,
    order_type: data.order_type,
    full_name: data.full_name,
    'date-arrival': data['date-arrival'],
    time_arrival: data.time_arrival,
    total_peoples: data.total_peoples,
    contact_number: data.contact_number,
    raw_json: raw
  };
  const res = await apiFetch(`${API_BASE}/orders/ingest`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    console.warn('Order ingest failed', err);
    throw new Error(err.detail || 'order save failed');
  }
}

function handleRealtimeEventMessage(data) {
  if (orderCapture.saved) return;
  let evt;
  try {
    evt = JSON.parse(data);
  } catch {
    return;
  }
  const texts = extractTextCandidates(evt);
  for (const text of texts) {
    if (!text) continue;
    if (orderCapture.buffer) {
      orderCapture.buffer += text;
    } else {
      const combined = orderCapture.markerTail + text;
      if (!combined.includes(ORDER_JSON_MARKER)) {
        orderCapture.markerTail = combined.slice(-(ORDER_JSON_MARKER.length - 1));
        continue;
      }
      const idx = combined.indexOf(ORDER_JSON_MARKER);
      orderCapture.buffer = combined.slice(idx);
    }
    if (orderCapture.buffer.length > 10000) {
      orderCapture.buffer = orderCapture.buffer.slice(-10000);
    }
    const parsed = parseOrderJsonFromBuffer(orderCapture.buffer);
    if (!parsed) continue;
    const normalized = normalizeOrderPayloadClient(parsed.data);
    if (normalized.missing.length) {
      console.warn('Order JSON missing fields', normalized.missing, parsed.data);
      orderCapture.buffer = '';
      orderCapture.markerTail = '';
      continue;
    }
    ingestOrder(normalized.data, parsed.raw)
      .then(() => {
        orderCapture.saved = true;
        toast('Order captured');
        if (document.getElementById('orders')?.classList.contains('active')) {
          loadOrders();
        }
      })
      .catch(() => toast('Order capture failed', 'error'));
    break;
  }
}

function orderStatusBadge(s) {
  if (!s) return `<span class="badge badge-amber">${t('Unknown')}</span>`;
  const sl = s.toLowerCase();
  if (sl.includes('incomplete')) return `<span class="badge badge-amber">${esc(s)}</span>`;
  if (sl.includes('complete')) return `<span class="badge badge-green">${esc(s)}</span>`;
  return `<span class="badge badge-blue">${esc(s)}</span>`;
}

async function loadOrders() {
  try {
    const orders = await (await apiFetch(`${API_BASE}/orders/`)).json();
    const tbody = document.getElementById('orderTable');
    if (!orders.length) {
      tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">#</div><p>${t('No orders recorded yet')}</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = orders.map(o => {
      const dateArrival = o['date-arrival'] || o.date_arrival || o.address || '';
      const timeArrival = o.time_arrival || o['time-arrival'] || o.house_number || '';
      const totalPeoples = o.total_peoples ?? o.total_people ?? o.ordered_items ?? '';
      const contactNumber = o.contact_number || o.contactNumber || o.payment_method || '';
      return `
        <tr>
          <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">#${o.id}</td>
          <td>${esc(o.restaurant)}</td>
          <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(o.full_name)}</td>
          <td>${esc(o.order_type)}</td>
          <td>${esc(dateArrival)}</td>
          <td>${esc(timeArrival)}</td>
          <td>${esc(totalPeoples)}</td>
          <td>${esc(contactNumber)}</td>
          <td>${orderStatusBadge(o.status)}</td>
          <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${esc(o.created)}</td>
        </tr>`;
    }).join('');
  } catch(e) {}
}

async function loadLogs() {
  try {
    const logs = await (await apiFetch(`${API_BASE}/calls/`)).json();
    const tbody = document.getElementById('logTable');
    const recent = document.getElementById('recentLogs');
    if (!logs.length) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üìµ</div><p>${t('No calls recorded yet')}</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = logs.map(l => `
      <tr>
        <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">#${l.id}</td>
        <td>${esc(l.restaurant)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.caller)}</td>
        <td>${statusBadge(l.status)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${formatDuration(l.duration)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${esc(l.created)}</td>
      </tr>`).join('');
    recent.innerHTML = logs.slice(0,5).map(l => `
      <tr>
        <td>${esc(l.restaurant)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.caller)}</td>
        <td>${statusBadge(l.status)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${formatDuration(l.duration)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${esc(l.created)}</td>
      </tr>`).join('');
  } catch(e) {}
}

async function loadRestaurants() {
  try {
    const data = await (await apiFetch(`${API_BASE}/restaurants/`)).json();
    restaurantsCache = data;
    if (currentUser?.is_admin) populateAdminRestaurant();
    const list = document.getElementById('rlist');
    if (!data.length) {
      list.innerHTML = `<div class="empty-state" style="padding:30px 16px"><div class="empty-icon" style="font-size:28px">üçΩÔ∏è</div><p>${t('No restaurants yet')}</p></div>`;
      return;
    }
    const isAdmin = !!currentUser?.is_admin;
    list.innerHTML = data.map(r => `
      <div class="r-item ${r.id === selectedId ? 'active' : ''}">
        <div class="r-dot ${r.active ? 'on' : 'off'}"></div>
        <span class="r-item-name" onclick="openRestaurant(${r.id})">${esc(r.name || 'Unnamed')}</span>
        ${isAdmin ? `
        <div class="r-item-actions">
          <button class="r-mini-btn" onclick="showAssignForRestaurant(${r.id})">üë§</button>
        </div>` : ``}
      </div>`).join('');
    if (selectedId) openRestaurant(selectedId, true);
  } catch(e) {}
}

function populateAdminRestaurant() {
  const sel = document.getElementById('adminRestaurant');
  if (!sel) return;
  sel.innerHTML = restaurantsCache.map(r => `<option value="${r.id}">${esc(r.name || 'Unnamed')}</option>`).join('');
}

async function loadAdminsForRestaurant(restaurantId) {
  const list = document.getElementById('adminList');
  if (!list) return;
  list.innerHTML = `<div style="color:var(--muted);font-size:12px">${t('Loading...')}</div>`;
  try {
    const data = await (await apiFetch(`${API_BASE}/auth/users/by-restaurant/${restaurantId}`)).json();
    usersCache = data;
    if (!data.length) {
      list.innerHTML = `<div style="color:var(--muted);font-size:12px">${t('No admins assigned')}</div>`;
      return;
    }
    list.innerHTML = data.map(u => `
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;border:1px solid var(--border);padding:8px;border-radius:8px;background:var(--surface2)">
        <div style="display:flex;flex-direction:column">
          <span style="font-size:13px">${esc(u.email)}</span>
          <span style="font-size:11px;color:var(--muted)">${u.active ? t('Active') : t('Inactive')}</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-secondary btn-sm" onclick="editRestaurantUser(${u.id})" title="${t('Edit User')}">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4z"/></svg>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteRestaurantUser(${u.id})" title="${t('Delete User')}">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          </button>
          <button class="btn btn-danger btn-sm" onclick="setUserStatus(${u.id}, ${u.active ? 'false' : 'true'})">
            ${u.active ? t('Revoke Access') : t('Restore Access')}
          </button>
        </div>
      </div>`).join('');
  } catch (e) {
    list.innerHTML = `<div style="color:var(--red);font-size:12px">${t('Failed')}</div>`;
  }
}

async function editRestaurantUser(userId) {
  const user = usersCache.find(u => u.id === userId);
  if (!user) {
    toast('Failed', 'error');
    return;
  }
  editingUserId = userId;
  const modal = document.getElementById('editUserModal');
  const err = document.getElementById('editUserError');
  const email = document.getElementById('editUserEmail');
  const password = document.getElementById('editUserPassword');
  if (err) err.textContent = '';
  if (email) email.value = user.email || '';
  if (password) password.value = '';
  modal?.classList.remove('auth-hidden');
  email?.focus();
}

async function saveEditedUser() {
  if (!editingUserId) return;
  const err = document.getElementById('editUserError');
  const newEmail = String(document.getElementById('editUserEmail')?.value || '').trim().toLowerCase();
  const newPassword = String(document.getElementById('editUserPassword')?.value || '').trim();
  if (!newEmail || !newEmail.includes('@') || !newEmail.includes('.')) {
    if (err) err.textContent = t('Invalid email');
    return;
  }
  if (newPassword && newPassword.length < 6) {
    if (err) err.textContent = t('Password too short');
    return;
  }
  const payload = { email: newEmail };
  if (newPassword) payload.password = newPassword;
  try {
    const res = await apiFetch(`${API_BASE}/auth/users/${editingUserId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || t('Failed'));
    }
    closeEditUserModal();
    const restaurantId = selectedId || parseInt(document.getElementById('adminRestaurant')?.value || '0', 10);
    if (restaurantId) loadAdminsForRestaurant(restaurantId);
    toast('User updated');
  } catch (e) {
    if (err) err.textContent = e.message || t('Failed');
  }
}

async function deleteRestaurantUser(userId) {
  if (!confirm(t('Delete this user? This cannot be undone.'))) return;
  try {
    const res = await apiFetch(`${API_BASE}/auth/users/${userId}`, { method: 'DELETE' });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || 'Failed');
    }
    const restaurantId = selectedId || parseInt(document.getElementById('adminRestaurant')?.value || '0', 10);
    if (restaurantId) loadAdminsForRestaurant(restaurantId);
    toast('User deleted');
  } catch (e) {
    toast(e.message || 'Failed', 'error');
  }
}

async function setUserStatus(userId, active) {
  try {
    await apiFetch(`${API_BASE}/auth/users/${userId}/status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ active })
    });
    const restaurantId = selectedId || parseInt(document.getElementById('adminRestaurant')?.value || '0', 10);
    if (restaurantId) loadAdminsForRestaurant(restaurantId);
    toast(active ? 'Restore Access' : 'Revoke Access');
  } catch (e) {
    toast('Failed', 'error');
  }
}

async function addRestaurant() {
  const name = document.getElementById('rname').value.trim();
  const phone = document.getElementById('rphone').value.trim();
  const prompt = document.getElementById('rprompt').value.trim();
  if (!name) { toast('Restaurant name is required', 'error'); return; }
  try {
    await apiFetch(`${API_BASE}/restaurants/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, ivr_text: prompt })
    });
    ['rname','rphone','rprompt'].forEach(id => document.getElementById(id).value = '');
    toast(`"${name}" added successfully`);
    loadRestaurants();
  } catch(e) { toast('Failed to add restaurant', 'error'); }
}

async function updateRestaurant(id) {
  const name = document.getElementById(`rname-${id}`).value.trim();
  const phone = document.getElementById(`rphone-${id}`).value.trim();
  const prompt = document.getElementById(`rprompt-${id}`).value;
  try {
    await apiFetch(`${API_BASE}/restaurants/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, ivr_text: prompt })
    });
    toast('Restaurant updated');
    loadRestaurants();
  } catch(e) { toast('Update failed', 'error'); }
}

function openRestaurant(id, silent) {
  selectedId = id;
  const r = restaurantsCache.find(x => x.id === id);
  if (!r) return;

  const isAdmin = !!currentUser?.is_admin;
  const isActive = r.active;
  const activeLabel = isActive ? t('Active') : t('Inactive');
  const toggleLabel = isActive ? `‚è∏ ${t('Deactivate')}` : `‚ñ∂ ${t('Activate')}`;
  const adminActions = isAdmin ? `
        <button class="btn btn-secondary btn-sm" onclick="toggleRestaurant(${r.id})">${toggleLabel}</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRestaurant(${r.id})">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          ${t('Delete')}
        </button>` : ``;

  document.getElementById('rdetail').innerHTML = `
    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
        ${esc(r.name || 'Unnamed')}
        <span class="badge ${isActive ? 'badge-green' : 'badge-red'}" style="margin-inline-start:auto">${activeLabel}</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">${t('Name')}</label>
          <input id="rname-${r.id}" value="${esc(r.name||'')}" placeholder="${t('Restaurant Name')}">
        </div>
        <div class="form-group">
          <label class="form-label">${t('Phone')}</label>
          <input id="rphone-${r.id}" value="${esc(r.phone||'')}" placeholder="+1 (555) 000-0000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">${t('IVR Prompt')}</label>
        <textarea id="rprompt-${r.id}">${esc(r.ivr_text||'')}</textarea>
      </div>
      <div class="actions">
        <button class="btn btn-primary btn-sm" onclick="updateRestaurant(${r.id})">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
          ${t('Save')}
        </button>
        ${adminActions}
      </div>
    </div>

    <div class="card">
      <div class="section-title">${t('Text Chat')}</div>
      <div class="chat-box" id="chat"></div>
      <div class="chat-input-row">
        <input id="chatMsg" placeholder="${t('Test the AI assistant...')}" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary btn-sm" onclick="sendChat()">${t('Send')}</button>
      </div>
    </div>

    ${isAdmin ? `
    <div class="card">
      <div class="section-title">${t('Admins for this restaurant')}</div>
      <div id="adminList" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>` : ``}

    <div class="card">
      <div class="section-title">${t('Voice Chat')}</div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px">${t('Voice Chat desc')}</p>
      <button class="voice-btn" id="voiceBtn" onclick="startVoice()">üéôÔ∏è ${t('Start Voice Session')}</button>
    </div>
 
    <div class="card">
      <div class="section-title">${t('Twilio Webhook')}</div>
      <div class="form-group">
        <label class="form-label">${t('Twilio Webhook URL')}</label>
        <div class="twilio-row">
          <input id="twilioUrl" readonly value="${esc(buildTwilioUrl(r.id))}">
          <button class="btn btn-secondary btn-sm" onclick="copyTwilioUrl()">${t('Copy')}</button>
        </div>
      </div>
      <span data-i18n="Tips">${t('Tips')}</span>
      <p style="font-size:13px;color:var(--muted);line-height:1.6">${t('Twilio guide')}</p>
    </div>
   

  `;
  setVoiceButtonState(voiceSession.active);
  
  if (isAdmin) loadAdminsForRestaurant(r.id);

  if (!silent) loadRestaurants();
}

async function toggleRestaurant(id) {
  try {
    await apiFetch(`${API_BASE}/restaurants/toggle/${id}`, { method: 'POST' });
    toast('Status updated');
    loadRestaurants();
  } catch(e) { toast('Failed', 'error'); }
}

function showAssignForRestaurant(id) {
  if (!currentUser?.is_admin) return;
  const box = document.getElementById('assignBox');
  const isSameRestaurant = assignBoxRestaurantId === id;

  if (assignBoxOpenedByIcon && isSameRestaurant) {
    assignBoxOpenedByIcon = false;
    assignBoxRestaurantId = null;
    if (box) box.style.display = 'none';
    return;
  }

  assignBoxOpenedByIcon = true;
  assignBoxRestaurantId = id;
  const sel = document.getElementById('adminRestaurant');
  if (sel) sel.value = String(id);
  if (box) box.style.display = 'block';
  const email = document.getElementById('adminEmail');
  if (email) email.focus();
  loadAdminsForRestaurant(id);
}

async function createOrAssignAdmin() {
  if (!currentUser?.is_admin) return;
  const email = document.getElementById('adminEmail').value.trim();
  const password = document.getElementById('adminPassword').value;
  const restaurantId = parseInt(document.getElementById('adminRestaurant').value, 10);
  if (!email || !restaurantId) { toast('Failed', 'error'); return; }

  const clearForm = () => {
    document.getElementById('adminEmail').value = '';
    document.getElementById('adminPassword').value = '';
  };

  const assignExisting = async () => {
    const res = await apiFetch(`${API_BASE}/auth/users/assign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, restaurant_id: restaurantId })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || 'assign failed');
    }
    toast('Admin assigned');
    clearForm();
  };

  try {
    if (!password) {
      await assignExisting();
      return;
    }

    const res = await apiFetch(`${API_BASE}/auth/users`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, restaurant_id: restaurantId })
    });
    if (res.ok) {
      toast('Admin assigned');
      clearForm();
      return;
    }
    const err = await res.json().catch(() => ({}));
    if (res.status === 409) {
      await assignExisting();
      return;
    }
    throw new Error(err.detail || 'create failed');
  } catch (e) {
    toast(e.message || 'Failed', 'error');
  }
}

async function deleteRestaurant(id) {
  if (!confirm(t('Delete this restaurant? This cannot be undone.'))) return;
  try {
    await apiFetch(`${API_BASE}/restaurants/${id}`, { method: 'DELETE' });
    selectedId = null;
    toast('Restaurant deleted');
    loadRestaurants();
    document.getElementById('rdetail').innerHTML = `
      <div class="card" style="text-align:center;padding:60px 20px">
        <div style="font-size:40px;margin-bottom:12px;opacity:0.25">üëÜ</div>
        <div style="color:var(--muted);font-size:14px">${t('Select a restaurant to manage it')}</div>
      </div>`;
  } catch(e) { toast('Delete failed', 'error'); }
}

function copyTwilioUrl() {
  const el = document.getElementById('twilioUrl');
  navigator.clipboard.writeText(el.value)
    .then(() => toast('Twilio URL copied'))
    .catch(() => toast('Copy failed', 'error'));
}

function setVoiceButtonState(active) {
  const btn = document.getElementById('voiceBtn');
  if (!btn) return;
  btn.textContent = active ? `üî¥ ${t('End Voice Session')}` : `üéôÔ∏è ${t('Start Voice Session')}`;
  btn.classList.toggle('active', !!active);
  btn.disabled = false;
}

function stopVoice() {
  try {
    voiceSession.pc?.getSenders()?.forEach(sender => sender.track?.stop());
  } catch (e) {}
  try {
    voiceSession.localStream?.getTracks()?.forEach(track => track.stop());
  } catch (e) {}
  try {
    voiceSession.dc?.close();
  } catch (e) {}
  try {
    voiceSession.pc?.close();
  } catch (e) {}
  if (voiceSession.audioEl) {
    voiceSession.audioEl.srcObject = null;
    voiceSession.audioEl.remove();
  }
  voiceSession = { pc: null, localStream: null, audioEl: null, dc: null, active: false };
  resetOrderCapture();
  setVoiceButtonState(false);
}

// ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendChat() {
  if (!selectedId) { toast('Select a restaurant first', 'error'); return; }
  const msg = document.getElementById('chatMsg').value.trim();
  if (!msg) return;
  const prompt = document.getElementById(`rprompt-${selectedId}`)?.value || '';
  const chatEl = document.getElementById('chat');

  chatEl.innerHTML += `<div class="chat-msg user"><div class="sender">${t('You')}</div><div class="bubble">${esc(msg)}</div></div>`;
  document.getElementById('chatMsg').value = '';
  chatEl.scrollTop = chatEl.scrollHeight;

  const typingId = 'typing-' + Date.now();
  chatEl.innerHTML += `<div class="chat-msg ai" id="${typingId}"><div class="sender">${t('AI')}</div><div class="bubble"><span class="loading"></span></div></div>`;
  chatEl.scrollTop = chatEl.scrollHeight;

  try {
    const r = await apiFetch(`${API_BASE}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, restaurant_prompt: prompt })
    });
    const data = await r.json();
    if (!r.ok || !data.reply) throw new Error('chat failed');
    document.getElementById(typingId).outerHTML = `<div class="chat-msg ai"><div class="sender">${t('AI')}</div><div class="bubble">${esc(data.reply)}</div></div>`;
  } catch(e) {
    document.getElementById(typingId).outerHTML = `<div class="chat-msg ai"><div class="sender">${t('AI')}</div><div class="bubble" style="color:var(--red)">${t('Server error, we will fix soon.')}</div></div>`;
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ VOICE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startVoice() {
  if (voiceSession.active) { stopVoice(); return; }
  if (!selectedId) { toast('Select a restaurant first', 'error'); return; }
  if (!window.isSecureContext || !navigator.mediaDevices?.getUserMedia) {
    toast('Voice requires HTTPS', 'error'); return;
  }
  resetOrderCapture();
  const prompt = document.getElementById(`rprompt-${selectedId}`)?.value || '';
  const btn = document.getElementById('voiceBtn');
  if (btn) btn.disabled = true;
  try {
    const session = await (await apiFetch(`${API_BASE}/voice-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ restaurant_prompt: prompt })
    })).json();
    if (!session.client_secret?.value) { toast('Voice session error', 'error'); return; }

    const pc = new RTCPeerConnection();
    const dc = pc.createDataChannel('oai-events');
    dc.onmessage = e => handleRealtimeEventMessage(e.data);
    dc.onopen = () => {
      try {
        dc.send(JSON.stringify({
          type: 'session.update',
          session: { output_modalities: ['audio'] }
        }));
      } catch (e) {}
    };
    const audioEl = document.createElement('audio');
    audioEl.autoplay = true;
    pc.ontrack = e => audioEl.srcObject = e.streams[0];
    const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    const realtimeModel = session.model || 'gpt-4o-realtime-preview';
    const sdpRes = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(realtimeModel)}`, {
      method: 'POST', body: offer.sdp,
      headers: { Authorization: `Bearer ${session.client_secret.value}`, 'Content-Type': 'application/sdp' }
    });
    if (!sdpRes.ok) throw new Error('sdp failed');
    const answerSdp = await sdpRes.text();
    if (!answerSdp) throw new Error('sdp answer missing');
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

    voiceSession = { pc, localStream, audioEl, dc, active: true };
    pc.onconnectionstatechange = () => {
      if (voiceSession.pc !== pc) return;
      if (['failed', 'disconnected', 'closed'].includes(pc.connectionState)) stopVoice();
    };
    setVoiceButtonState(true);
    toast('Voice session started');
  } catch(e) {
    stopVoice();
    toast('Voice session error', 'error');
  } finally {
    const activeBtn = document.getElementById('voiceBtn');
    if (activeBtn) activeBtn.disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Apply saved language on load
if (currentLang === 'he') setLang('he');

checkAuth().then(ok => {
  if (ok) initAfterAuth();
});
</script>
</body>
</html>
