<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceIQ â€” Restaurant IVR Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1220;
    --surface2: #111827;
    --border: #1e2d45;
    --accent: #0ea5e9;
    --accent2: #38bdf8;
    --accent-glow: rgba(14,165,233,0.15);
    --green: #10b981;
    --red: #f43f5e;
    --amber: #f59e0b;
    --text: #f0f6ff;
    --muted: #64748b;
    --subtle: #1e293b;
    --radius: 12px;
    --radius-sm: 8px;
    --sidebar-w: 220px;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    direction: ltr;
  }

  /* RTL body override */
  body[dir="rtl"] {
    font-family: 'DM Sans', 'Segoe UI', Arial, sans-serif;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% -10%, rgba(14,165,233,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(56,189,248,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar {
    position: fixed;
    top: 0; bottom: 0;
    left: 0;
    right: auto;
    width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
  }

  .logo {
    padding: 24px 20px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 34px; height: 34px;
    background: linear-gradient(135deg, var(--accent), #0284c7);
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    box-shadow: 0 0 20px rgba(14,165,233,0.3);
    flex-shrink: 0;
  }

  .logo-text {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo-text span { color: var(--accent); }

  .nav {
    padding: 16px 12px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
    overflow-y: auto;
  }

  .nav-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 12px 8px 6px;
    text-align: start;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--muted);
    cursor: pointer;
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 400;
    transition: all 0.18s;
    text-align: start;
  }

  .nav-btn:hover { background: var(--subtle); color: var(--text); }

  .nav-btn.active {
    background: var(--accent-glow);
    color: var(--accent2);
    border-color: rgba(14,165,233,0.25);
  }

  .nav-btn .icon {
    width: 18px; height: 18px;
    opacity: 0.7;
    flex-shrink: 0;
  }

  .nav-btn.active .icon { opacity: 1; }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(16,185,129,0.08);
    border: 1px solid rgba(16,185,129,0.2);
    border-radius: 20px;
    font-size: 12px;
    color: var(--green);
    font-family: 'DM Mono', monospace;
  }

  .status-dot {
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
    flex-shrink: 0;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* â”€â”€ MAIN â”€â”€ */
  .main {
    margin-left: var(--sidebar-w);
    margin-right: 0;
    padding: 32px;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  .page { display: none; animation: fadeIn 0.25s ease; }
  .page.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* â”€â”€ PAGE HEADER â”€â”€ */
  .page-header { margin-bottom: 28px; }

  .page-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 26px;
    letter-spacing: -0.5px;
  }

  .page-subtitle { color: var(--muted); font-size: 14px; margin-top: 4px; }

  /* â”€â”€ CARDS â”€â”€ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: #2a3f5f; }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title svg { color: var(--accent); flex-shrink: 0; }

  /* â”€â”€ STATS â”€â”€ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 22px;
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
  }

  .stat-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(14,165,233,0.1);
  }

  .stat-card::after {
    content: '';
    position: absolute;
    top: 0; inset-inline-start: 0; inset-inline-end: 0;
    height: 2px;
    background: linear-gradient(to inline-end, var(--accent), transparent);
  }

  /* Fix for RTL gradient direction */
  [dir="rtl"] .stat-card::after {
    background: linear-gradient(to left, var(--accent), transparent);
  }
  [dir="ltr"] .stat-card::after {
    background: linear-gradient(to right, var(--accent), transparent);
  }

  .stat-label {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
  }

  .stat-icon {
    position: absolute;
    top: 18px; inset-inline-end: 18px;
    width: 34px; height: 34px;
    background: var(--accent-glow);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    border: 1px solid rgba(14,165,233,0.15);
  }

  /* â”€â”€ FORMS â”€â”€ */
  .form-group { margin-bottom: 16px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 6px;
  }

  input, textarea, select {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-align: start;
    direction: inherit;
  }

  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  input::placeholder, textarea::placeholder { color: var(--muted); }

  textarea { resize: vertical; min-height: 110px; line-height: 1.6; }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 10px 18px;
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 0 20px rgba(14,165,233,0.25);
    border-color: var(--accent);
  }

  .btn-primary:hover {
    background: var(--accent2);
    box-shadow: 0 0 28px rgba(14,165,233,0.4);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--subtle);
    color: var(--text);
    border-color: var(--border);
  }

  .btn-secondary:hover { background: var(--surface2); border-color: #2a3f5f; }

  .btn-danger {
    background: rgba(244,63,94,0.12);
    color: var(--red);
    border-color: rgba(244,63,94,0.25);
  }

  .btn-danger:hover { background: rgba(244,63,94,0.22); border-color: var(--red); }

  .btn-ghost {
    background: transparent;
    color: var(--muted);
  }

  .btn-ghost:hover { background: var(--subtle); color: var(--text); border-color: var(--border); }

  .btn-sm { padding: 7px 13px; font-size: 13px; }

  .btn-success {
    background: rgba(16,185,129,0.12);
    color: var(--green);
    border-color: rgba(16,185,129,0.25);
  }

  .btn-success:hover { background: rgba(16,185,129,0.2); }

  .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }

  /* â”€â”€ SPLIT LAYOUT â”€â”€ */
  .split-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 20px;
    align-items: start;
  }

  /* â”€â”€ RESTAURANT LIST â”€â”€ */
  .restaurant-list {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .r-list-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .r-list-inner { padding: 8px; max-height: 560px; overflow-y: auto; }
  .r-list-inner::-webkit-scrollbar { width: 4px; }
  .r-list-inner::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .r-item {
    width: 100%;
    padding: 11px 12px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    text-align: start;
    transition: all 0.15s;
    margin-bottom: 2px;
  }

  .r-item:hover { background: var(--subtle); color: var(--text); }

  .r-item.active {
    background: var(--accent-glow);
    border-color: rgba(14,165,233,0.3);
    color: var(--accent2);
  }

  .r-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .r-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .r-dot.off { background: var(--muted); }
  .r-item-name { flex: 1; font-weight: 500; }

  /* â”€â”€ CHAT â”€â”€ */
  .chat-box {
    height: 200px;
    overflow-y: auto;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-box::-webkit-scrollbar { width: 4px; }
  .chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .chat-msg { display: flex; flex-direction: column; gap: 2px; }

  .chat-msg .sender {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
  }

  .chat-msg.user .sender { color: var(--accent); }
  .chat-msg.ai .sender { color: var(--green); }

  .chat-msg .bubble {
    display: inline-block;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 90%;
  }

  .chat-msg.user { align-items: flex-end; }
  .chat-msg.ai { align-items: flex-start; }

  [dir="rtl"] .chat-msg.user { align-items: flex-start; }
  [dir="rtl"] .chat-msg.ai { align-items: flex-end; }

  .chat-msg.user .bubble {
    background: var(--accent-glow);
    border: 1px solid rgba(14,165,233,0.2);
    color: var(--text);
  }

  .chat-msg.ai .bubble {
    background: var(--subtle);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .chat-input-row { display: flex; gap: 8px; }
  .chat-input-row input { flex: 1; }

  /* â”€â”€ TABLE â”€â”€ */
  .data-table { width: 100%; border-collapse: collapse; }

  .data-table thead tr { border-bottom: 1px solid var(--border); }

  .data-table th {
    padding: 10px 14px;
    text-align: start;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 400;
  }

  .data-table td {
    padding: 13px 14px;
    font-size: 13px;
    border-bottom: 1px solid rgba(30,45,69,0.5);
    color: #c4d4e8;
    vertical-align: middle;
  }

  .data-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .data-table tbody tr:last-child td { border-bottom: none; }

  /* â”€â”€ BADGES â”€â”€ */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    white-space: nowrap;
  }

  .badge-green { background: rgba(16,185,129,0.12); color: var(--green); border: 1px solid rgba(16,185,129,0.2); }
  .badge-red   { background: rgba(244,63,94,0.12);  color: var(--red);   border: 1px solid rgba(244,63,94,0.2); }
  .badge-amber { background: rgba(245,158,11,0.12); color: var(--amber); border: 1px solid rgba(245,158,11,0.2); }
  .badge-blue  { background: var(--accent-glow);    color: var(--accent2);border: 1px solid rgba(14,165,233,0.2); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
  .empty-state p { font-size: 14px; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed;
    bottom: 24px;
    inset-inline-end: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 9999;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    pointer-events: none;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    max-width: 320px;
  }

  #toast.show { opacity: 1; transform: translateY(0); }
  #toast.success { border-color: rgba(16,185,129,0.4); }
  #toast.success .toast-dot { background: var(--green); }
  #toast.error { border-color: rgba(244,63,94,0.4); }
  #toast.error .toast-dot { background: var(--red); }

  .toast-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: var(--green); }

  /* â”€â”€ VOICE BUTTON â”€â”€ */
  .voice-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 24px;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: var(--radius);
    color: var(--green);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
  }

  .voice-btn:hover {
    background: rgba(16,185,129,0.18);
    border-color: var(--green);
    box-shadow: 0 0 20px rgba(16,185,129,0.15);
  }

  .voice-btn.active { background: rgba(244,63,94,0.1); border-color: var(--red); color: var(--red); }

  /* â”€â”€ SECTION TITLE â”€â”€ */
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ LOADING â”€â”€ */
  .loading {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(14,165,233,0.3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ TWILIO â”€â”€ */
  .twilio-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
  }

  /* â”€â”€ LANG SWITCHER â”€â”€ */
  #lang-switcher {
    position: fixed;
    top: 14px;
    inset-inline-end: 14px;
    z-index: 10000;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0;
    overflow: hidden;
    display: flex;
  }

  .lang-opt {
    padding: 7px 13px;
    background: transparent;
    border: none;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .lang-opt:hover { background: var(--subtle); color: var(--text); }
  .lang-opt.active { background: var(--accent-glow); color: var(--accent2); }

  .lang-divider { width: 1px; background: var(--border); flex-shrink: 0; }

  /* â”€â”€ RTL-SPECIFIC FIXES â”€â”€ */
  /* Sidebar stays on the left in both LTR and RTL */
  [dir="rtl"] .sidebar {
    left: 0;
    right: auto;
  }

  [dir="ltr"] .sidebar {
    left: 0;
    right: auto;
  }

  /* Card-title badge push */
  .card-title .badge-ml { margin-inline-start: auto; }
</style>
</head>
<body dir="ltr">

<!-- Language Switcher -->
<div id="lang-switcher">
  <button class="lang-opt active" onclick="setLang('en')">EN</button>
  <div class="lang-divider"></div>
  <button class="lang-opt" onclick="setLang('he')">×¢×‘</button>
</div>

<!-- Sidebar -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-icon">ğŸ™ï¸</div>
    <div class="logo-text">Voice<span>IQ</span></div>
  </div>

  <div class="nav">
    <div class="nav-label" data-i18n="Platform">Platform</div>
    <button class="nav-btn active" onclick="show('dash',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span data-i18n="Dashboard">Dashboard</span>
    </button>
    <button class="nav-btn" onclick="show('global',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      <span data-i18n="Global Prompt">Global Prompt</span>
    </button>
    <button class="nav-btn" onclick="show('restaurants',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
      <span data-i18n="Restaurants">Restaurants</span>
    </button>
    <button class="nav-btn" onclick="show('logs',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <span data-i18n="Call Logs">Call Logs</span>
    </button>
  </div>

  <div class="sidebar-footer">
    <div class="status-pill">
      <div class="status-dot"></div>
      <span data-i18n="System Online">System Online</span>
    </div>
  </div>
</nav>

<!-- Main content -->
<main class="main">

  <!-- Dashboard -->
  <div id="dash" class="page active">
    <div class="page-header">
      <div class="page-title" data-i18n="Dashboard">Dashboard</div>
      <div class="page-subtitle" data-i18n="Platform performance overview">Platform performance overview</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label" data-i18n="Active Restaurants">Active Restaurants</div>
        <div class="stat-value" id="s-restaurants">â€”</div>
        <div class="stat-icon">ğŸ½ï¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Total Calls">Total Calls</div>
        <div class="stat-value" id="s-calls">â€”</div>
        <div class="stat-icon">ğŸ“</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Missed Calls">Missed Calls</div>
        <div class="stat-value" id="s-missed">â€”</div>
        <div class="stat-icon">ğŸ“µ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Avg Duration">Avg Duration</div>
        <div class="stat-value" id="s-duration">â€”</div>
        <div class="stat-icon">â±ï¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="API Usage">API Usage</div>
        <div class="stat-value" id="s-usage">0</div>
        <div class="stat-icon">ğŸ”Œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label" data-i18n="Usage Cost">Usage Cost</div>
        <div class="stat-value" id="s-cost">$0.00</div>
        <div class="stat-icon">ğŸ’³</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        <span data-i18n="Recent Activity">Recent Activity</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th data-i18n="Restaurant">Restaurant</th>
            <th data-i18n="Caller">Caller</th>
            <th data-i18n="Status">Status</th>
            <th data-i18n="Duration">Duration</th>
            <th data-i18n="Date">Date</th>
          </tr>
        </thead>
        <tbody id="recentLogs">
          <tr><td colspan="5"><div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p data-i18n="No recent calls">No recent calls</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Global Prompt -->
  <div id="global" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Global Prompt">Global Prompt</div>
      <div class="page-subtitle" data-i18n="global-sub">This prompt is injected into every restaurant's AI context</div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        <span data-i18n="Base System Prompt">Base System Prompt</span>
      </div>
      <div class="form-group">
        <label class="form-label" data-i18n="Prompt Content">Prompt Content</label>
        <textarea id="globalPrompt" style="min-height:180px"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="saveGlobal()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          <span data-i18n="Save Changes">Save Changes</span>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span data-i18n="Tips">Tips</span>
      </div>
      <p style="font-size:13px;color:var(--muted);line-height:1.7" data-i18n="global-tip">
        The global prompt sets the baseline behavior for all restaurants. Each restaurant's individual prompt is appended after this, allowing per-restaurant customization.
      </p>
    </div>
  </div>

  <!-- Restaurants -->
  <div id="restaurants" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Restaurants">Restaurants</div>
      <div class="page-subtitle" data-i18n="Manage connected restaurant profiles">Manage connected restaurant profiles</div>
    </div>

    <div class="split-layout">
      <div class="restaurant-list">
        <div class="r-list-header">
          <span data-i18n="Restaurant List">Restaurant List</span>
          <button class="btn btn-ghost btn-sm" onclick="toggleCreate()" title="Add new">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <div class="r-list-inner" id="rlist">
          <div class="empty-state" style="padding:30px 16px">
            <div class="empty-icon" style="font-size:28px">ğŸ½ï¸</div>
            <p data-i18n="No restaurants yet">No restaurants yet</p>
          </div>
        </div>
      </div>

      <div id="rightPane">
        <div id="createBox" class="card" style="display:none">
          <div class="card-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span data-i18n="Create Restaurant">Create Restaurant</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" data-i18n="Restaurant Name">Restaurant Name</label>
              <input id="rname" data-placeholder-i18n="e.g. Bella Italia">
            </div>
            <div class="form-group">
              <label class="form-label" data-i18n="Phone Number">Phone Number</label>
              <input id="rphone" placeholder="+1 (555) 000-0000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" data-i18n="IVR Prompt">IVR Prompt</label>
            <textarea id="rprompt"></textarea>
          </div>
          <div class="actions">
            <button class="btn btn-primary" onclick="addRestaurant()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              <span data-i18n="Create Restaurant">Create Restaurant</span>
            </button>
          </div>
        </div>

        <div id="rdetail">
          <div class="card" style="text-align:center; padding:60px 20px">
            <div style="font-size:40px;margin-bottom:12px;opacity:0.25">ğŸ‘†</div>
            <div style="color:var(--muted);font-size:14px" data-i18n="Select a restaurant to manage it">Select a restaurant to manage it</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Logs -->
  <div id="logs" class="page">
    <div class="page-header">
      <div class="page-title" data-i18n="Call Logs">Call Logs</div>
      <div class="page-subtitle" data-i18n="Full history of all IVR interactions">Full history of all IVR interactions</div>
    </div>

    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.6 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6a16 16 0 0 0 6.29 6.29l.96-.96a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        <span data-i18n="All Calls">All Calls</span>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th data-i18n="Restaurant">Restaurant</th>
            <th data-i18n="Caller">Caller</th>
            <th data-i18n="Status">Status</th>
            <th data-i18n="Duration">Duration</th>
            <th data-i18n="Date">Date</th>
          </tr>
        </thead>
        <tbody id="logTable">
          <tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ“µ</div><p data-i18n="No calls recorded yet">No calls recorded yet</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<!-- Toast -->
<div id="toast">
  <div class="toast-dot"></div>
  <span id="toastMsg"></span>
</div>

<script>
// â”€â”€â”€ I18N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TRANSLATIONS = {
  he: {
    "Platform": "×¤×œ×˜×¤×•×¨××”",
    "Dashboard": "×œ×•×— ×‘×§×¨×”",
    "Global Prompt": "×¤×¨×•××¤×˜ ×’×œ×•×‘×œ×™",
    "Restaurants": "××¡×¢×“×•×ª",
    "Call Logs": "×™×•×× ×™ ×©×™×—×•×ª",
    "System Online": "×”××¢×¨×›×ª ×¤×¢×™×œ×”",
    "Platform performance overview": "×¡×§×™×¨×ª ×‘×™×¦×•×¢×™ ×”×¤×œ×˜×¤×•×¨××”",
    "Active Restaurants": "××¡×¢×“×•×ª ×¤×¢×™×œ×•×ª",
    "Total Calls": "×¡×”×´×› ×©×™×—×•×ª",
    "Missed Calls": "×©×™×—×•×ª ×©×œ× × ×¢× ×•",
    "Avg Duration": "××©×š ×××•×¦×¢",
    "API Usage": "×©×™××•×© ×‘-API",
    "Usage Cost": "×¢×œ×•×ª ×©×™××•×©",
    "Recent Activity": "×¤×¢×™×œ×•×ª ××—×¨×•× ×”",
    "Restaurant": "××¡×¢×“×”",
    "Caller": "××ª×§×©×¨",
    "Status": "×¡×˜×˜×•×¡",
    "Duration": "××©×š",
    "Date": "×ª××¨×™×š",
    "No recent calls": "××™×Ÿ ×©×™×—×•×ª ××—×¨×•× ×•×ª",
    "Base System Prompt": "×¤×¨×•××¤×˜ ××¢×¨×›×ª ×‘×¡×™×¡×™",
    "Prompt Content": "×ª×•×›×Ÿ ×”×¤×¨×•××¤×˜",
    "Save Changes": "×©××•×¨ ×©×™× ×•×™×™×",
    "Tips": "×˜×™×¤×™×",
    "global-sub": "×¤×¨×•××¤×˜ ×–×” ××•×–×¨×§ ×œ×›×œ ×”×§×©×¨ ×”-AI ×©×œ ×”××¡×¢×“×”",
    "global-tip": "×”×¤×¨×•××¤×˜ ×”×’×œ×•×‘×œ×™ ×§×•×‘×¢ ××ª ×”×”×ª× ×”×’×•×ª ×”×‘×¡×™×¡×™×ª ×œ×›×œ ×”××¡×¢×“×•×ª. ×”×¤×¨×•××¤×˜ ×©×œ ×›×œ ××¡×¢×“×” ××¦×•×¨×£ ××—×¨×™×•.",
    "Restaurant List": "×¨×©×™××ª ××¡×¢×“×•×ª",
    "No restaurants yet": "××™×Ÿ ×¢×“×™×™×Ÿ ××¡×¢×“×•×ª",
    "Create Restaurant": "×™×¦×™×¨×ª ××¡×¢×“×”",
    "Restaurant Name": "×©× ×”××¡×¢×“×”",
    "Phone Number": "××¡×¤×¨ ×˜×œ×¤×•×Ÿ",
    "IVR Prompt": "×¤×¨×•××¤×˜ IVR",
    "Select a restaurant to manage it": "×‘×—×¨ ××¡×¢×“×” ×›×“×™ ×œ× ×”×œ ××•×ª×”",
    "Manage connected restaurant profiles": "× ×™×”×•×œ ×¤×¨×•×¤×™×œ×™ ××¡×¢×“×•×ª ××—×•×‘×¨×•×ª",
    "All Calls": "×›×œ ×”×©×™×—×•×ª",
    "Full history of all IVR interactions": "×”×™×¡×˜×•×¨×™×” ××œ××” ×©×œ ×›×œ ××™× ×˜×¨××§×¦×™×•×ª ×”-IVR",
    "No calls recorded yet": "×¢×“×™×™×Ÿ ×œ× × ×¨×©××• ×©×™×—×•×ª",
    "Name": "×©×",
    "Phone": "×˜×œ×¤×•×Ÿ",
    "Save": "×©××•×¨",
    "Delete": "××—×§",
    "Active": "×¤×¢×™×œ",
    "Inactive": "×œ× ×¤×¢×™×œ",
    "Text Chat": "×¦'××˜ ×˜×§×¡×˜",
    "Voice Chat": "×¦'××˜ ×§×•×œ×™",
    "Voice Chat desc": "×”×ª×—×œ ×©×™×—×” ×§×•×œ×™×ª ×‘×–××Ÿ ×××ª ×¢× ×”×¢×•×–×¨.",
    "Start Voice Session": "×”×ª×—×œ ×©×™×—×” ×§×•×œ×™×ª",
    "End Voice Session": "×¡×™×™× ×©×™×—×” ×§×•×œ×™×ª",
    "Twilio Webhook": "×•×•×‘×”×•×§ Twilio",
    "Twilio desc": "×”×“×‘×§ URL ×–×” ×‘-Twilio â† A Call Comes In",
    "Public Base URL (ngrok/hosted)": "×›×ª×•×‘×ª ×‘×¡×™×¡ ×¦×™×‘×•×¨×™×ª (ngrok/hosted)",
    "Twilio Webhook URL": "×›×ª×•×‘×ª Webhook ×©×œ Twilio",
    "Copy": "×”×¢×ª×§",
    "You": "××ª×”",
    "AI": "AI",
    "Deactivate": "×”×©×‘×ª",
    "Activate": "×”×¤×¢×œ",
    // toasts
    "Global prompt saved successfully": "×”×¤×¨×•××¤×˜ ×”×’×œ×•×‘×œ×™ × ×©××¨",
    "Failed to save": "×”×©××™×¨×” × ×›×©×œ×”",
    "Restaurant name is required": "×©× ××¡×¢×“×” ×”×•× ×©×“×” ×—×•×‘×”",
    "Failed to add restaurant": "×”×•×¡×¤×ª ×”××¡×¢×“×” × ×›×©×œ×”",
    "Restaurant updated": "×”××¡×¢×“×” ×¢×•×“×›× ×”",
    "Update failed": "×”×¢×“×›×•×Ÿ × ×›×©×œ",
    "Status updated": "×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ",
    "Failed": "× ×›×©×œ",
    "Restaurant deleted": "×”××¡×¢×“×” × ××—×§×”",
    "Delete failed": "×”××—×™×§×” × ×›×©×œ×”",
    "Select a restaurant first": "×‘×—×¨ ××¡×¢×“×” ×§×•×“×",
    "Server error, we will fix soon.": "×©×’×™××ª ×©×¨×ª, × ×˜×¤×œ ×‘×–×” ×‘×§×¨×•×‘.",
    "Connection error": "×©×’×™××ª ×—×™×‘×•×¨",
    "Voice session started": "×”×©×™×—×” ×”×§×•×œ×™×ª ×”×ª×—×™×œ×”",
    "Voice session error": "×©×’×™××ª ×©×™×—×” ×§×•×œ×™×ª",
    "Voice requires HTTPS": "×©×™×—×” ×§×•×œ×™×ª ×“×•×¨×©×ª HTTPS ×¢× ×’×™×©×ª ××™×§×¨×•×¤×•×Ÿ",
    "Twilio URL copied": "×›×ª×•×‘×ª Twilio ×”×•×¢×ª×§×”",
    "Copy failed": "×”×”×¢×ª×§×” × ×›×©×œ×”",
    "Delete this restaurant? This cannot be undone.": "×œ××—×•×§ ××ª ×”××¡×¢×“×”? ×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ.",
  }
};

let currentLang = localStorage.getItem('ui_lang') || 'en';

function t(key) {
  if (currentLang === 'en') return key;
  return (TRANSLATIONS.he && TRANSLATIONS.he[key]) || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('ui_lang', lang);

  // Update html dir + lang
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
  document.body.dir = lang === 'he' ? 'rtl' : 'ltr';

  // Lang switcher buttons
  document.querySelectorAll('.lang-opt').forEach(b => {
    b.classList.toggle('active', b.textContent.trim() === (lang === 'en' ? 'EN' : '×¢×‘'));
  });

  // Translate all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const translated = t(key);
    if (translated !== key || lang === 'en') {
      el.textContent = translated;
    }
  });

  // Translate placeholders
  document.querySelectorAll('[data-placeholder-i18n]').forEach(el => {
    const key = el.getAttribute('data-placeholder-i18n');
    el.placeholder = t(key);
  });

  // Re-render restaurant detail if open (to translate dynamic content)
  if (selectedId) openRestaurant(selectedId, true);
}

// â”€â”€â”€ CORE APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = (() => {
  const isLocalStaticFrontend =
    (window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1" ||
      window.location.hostname === "::1") &&
    window.location.port === "8000";

  const apiOrigin = isLocalStaticFrontend
    ? window.location.origin.replace(":8000", ":5050")
    : window.location.origin;

  return isLocalStaticFrontend ? apiOrigin : `${apiOrigin}/api`;
})();
let restaurantsCache = [];
let selectedId = null;

function show(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (id === 'logs') loadLogs();
  if (id === 'restaurants') loadRestaurants();
}

let toastTimer;
function toast(msg, type = 'success') {
  clearTimeout(toastTimer);
  const el = document.getElementById('toast');
  el.className = `show ${type}`;
  document.getElementById('toastMsg').textContent = t(msg);
  toastTimer = setTimeout(() => { el.className = ''; }, 3200);
}

function esc(v) {
  return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function normalizeUrl(url) {
  return String(url || '').trim().replace(/\/+$/, '');
}

function sanitizeTwilioBaseUrl(url) {
  let cleaned = normalizeUrl(url);
  cleaned = cleaned.replace(/\/incoming-call(?:\/\d+)?(?:\?.*)?$/i, '');
  return cleaned;
}

function getPublicBaseUrl() {
  return sanitizeTwilioBaseUrl(localStorage.getItem('twilioBaseUrl') || '');
}

function setPublicBaseUrl(url) {
  localStorage.setItem('twilioBaseUrl', sanitizeTwilioBaseUrl(url));
}

function getTwilioBaseUrl() {
  return sanitizeTwilioBaseUrl(getPublicBaseUrl() || API_BASE);
}

function buildTwilioUrl(id) {
  const base = getTwilioBaseUrl();
  return `${base}/incoming-call/${id}`;
}

function toggleCreate() {
  const box = document.getElementById('createBox');
  box.style.display = box.style.display === 'none' ? 'block' : 'none';
}

// â”€â”€â”€ API CALLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGlobal() {
  try {
    const r = await fetch(`${API_BASE}/prompt/`);
    const d = await r.json();
    document.getElementById('globalPrompt').value = d.prompt || '';
  } catch(e) {}
}

async function saveGlobal() {
  try {
    await fetch(`${API_BASE}/prompt/save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: document.getElementById('globalPrompt').value })
    });
    toast('Global prompt saved successfully');
  } catch(e) { toast('Failed to save', 'error'); }
}

async function loadStats() {
  try {
    const s = await (await fetch(`${API_BASE}/dashboard/stats`)).json();
    document.getElementById('s-restaurants').textContent = s.restaurants ?? 0;
    document.getElementById('s-calls').textContent = s.calls ?? 0;
    document.getElementById('s-missed').textContent = s.missed ?? 0;
    document.getElementById('s-duration').textContent = (Math.round((s.avg_duration ?? 0) * 10) / 10) + 's';
  } catch(e) {}
}

function statusBadge(s) {
  if (!s) return `<span class="badge badge-amber">${t('Unknown')}</span>`;
  const sl = s.toLowerCase();
  if (sl.includes('answer') || sl.includes('complet')) return `<span class="badge badge-green">${esc(s)}</span>`;
  if (sl.includes('miss') || sl.includes('fail')) return `<span class="badge badge-red">${esc(s)}</span>`;
  return `<span class="badge badge-blue">${esc(s)}</span>`;
}

async function loadLogs() {
  try {
    const logs = await (await fetch(`${API_BASE}/calls/`)).json();
    const tbody = document.getElementById('logTable');
    const recent = document.getElementById('recentLogs');
    if (!logs.length) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ“µ</div><p>${t('No calls recorded yet')}</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = logs.map(l => `
      <tr>
        <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">#${l.id}</td>
        <td>${esc(l.restaurant)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.caller)}</td>
        <td>${statusBadge(l.status)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.duration)}s</td>
        <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${esc(l.created)}</td>
      </tr>`).join('');
    recent.innerHTML = logs.slice(0,5).map(l => `
      <tr>
        <td>${esc(l.restaurant)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.caller)}</td>
        <td>${statusBadge(l.status)}</td>
        <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(l.duration)}s</td>
        <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">${esc(l.created)}</td>
      </tr>`).join('');
  } catch(e) {}
}

async function loadRestaurants() {
  try {
    const data = await (await fetch(`${API_BASE}/restaurants/`)).json();
    restaurantsCache = data;
    const list = document.getElementById('rlist');
    if (!data.length) {
      list.innerHTML = `<div class="empty-state" style="padding:30px 16px"><div class="empty-icon" style="font-size:28px">ğŸ½ï¸</div><p>${t('No restaurants yet')}</p></div>`;
      return;
    }
    list.innerHTML = data.map(r => `
      <button class="r-item ${r.id === selectedId ? 'active' : ''}" onclick="openRestaurant(${r.id})">
        <div class="r-dot ${r.active ? 'on' : 'off'}"></div>
        <span class="r-item-name">${esc(r.name || 'Unnamed')}</span>
      </button>`).join('');
    if (selectedId) openRestaurant(selectedId, true);
  } catch(e) {}
}

async function addRestaurant() {
  const name = document.getElementById('rname').value.trim();
  const phone = document.getElementById('rphone').value.trim();
  const prompt = document.getElementById('rprompt').value.trim();
  if (!name) { toast('Restaurant name is required', 'error'); return; }
  try {
    await fetch(`${API_BASE}/restaurants/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, ivr_text: prompt })
    });
    ['rname','rphone','rprompt'].forEach(id => document.getElementById(id).value = '');
    toast(`"${name}" added successfully`);
    loadRestaurants();
  } catch(e) { toast('Failed to add restaurant', 'error'); }
}

async function updateRestaurant(id) {
  const name = document.getElementById(`rname-${id}`).value.trim();
  const phone = document.getElementById(`rphone-${id}`).value.trim();
  const prompt = document.getElementById(`rprompt-${id}`).value;
  try {
    await fetch(`${API_BASE}/restaurants/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, ivr_text: prompt })
    });
    toast('Restaurant updated');
    loadRestaurants();
  } catch(e) { toast('Update failed', 'error'); }
}

function openRestaurant(id, silent) {
  selectedId = id;
  const r = restaurantsCache.find(x => x.id === id);
  if (!r) return;

  const isActive = r.active;
  const activeLabel = isActive ? t('Active') : t('Inactive');
  const toggleLabel = isActive ? `â¸ ${t('Deactivate')}` : `â–¶ ${t('Activate')}`;

  document.getElementById('rdetail').innerHTML = `
    <div class="card">
      <div class="card-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
        ${esc(r.name || 'Unnamed')}
        <span class="badge ${isActive ? 'badge-green' : 'badge-red'}" style="margin-inline-start:auto">${activeLabel}</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">${t('Name')}</label>
          <input id="rname-${r.id}" value="${esc(r.name||'')}" placeholder="${t('Restaurant Name')}">
        </div>
        <div class="form-group">
          <label class="form-label">${t('Phone')}</label>
          <input id="rphone-${r.id}" value="${esc(r.phone||'')}" placeholder="+1 (555) 000-0000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">${t('IVR Prompt')}</label>
        <textarea id="rprompt-${r.id}">${esc(r.ivr_text||'')}</textarea>
      </div>
      <div class="actions">
        <button class="btn btn-primary btn-sm" onclick="updateRestaurant(${r.id})">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
          ${t('Save')}
        </button>
        <button class="btn btn-secondary btn-sm" onclick="toggleRestaurant(${r.id})">${toggleLabel}</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRestaurant(${r.id})">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          ${t('Delete')}
        </button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">${t('Text Chat')}</div>
      <div class="chat-box" id="chat"></div>
      <div class="chat-input-row">
        <input id="chatMsg" placeholder="${t('Test the AI assistant...')}" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary btn-sm" onclick="sendChat()">${t('Send')}</button>
      </div>
    </div>

    <div class="card">
      <div class="section-title">${t('Voice Chat')}</div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px">${t('Voice Chat desc')}</p>
      <button class="voice-btn" id="voiceBtn" onclick="startVoice()">ğŸ™ï¸ ${t('Start Voice Session')}</button>
    </div>

    <div class="card">
      <div class="section-title">${t('Twilio Webhook')}</div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px">${t('Twilio desc')}</p>
      <div class="form-group">
        <label class="form-label">${t('Public Base URL (ngrok/hosted)')}</label>
        <input id="twilioBaseUrl" placeholder="https://xxxx.ngrok-free.app" value="${esc(getPublicBaseUrl())}"
          oninput="setPublicBaseUrl(this.value); document.getElementById('twilioUrl').value=buildTwilioUrl(${r.id})"
          onblur="setPublicBaseUrl(this.value); document.getElementById('twilioUrl').value=buildTwilioUrl(${r.id})">
      </div>
      <div class="form-group">
        <label class="form-label">${t('Twilio Webhook URL')}</label>
        <div class="twilio-row">
          <input id="twilioUrl" readonly value="${esc(buildTwilioUrl(r.id))}">
          <button class="btn btn-secondary btn-sm" onclick="copyTwilioUrl()">${t('Copy')}</button>
        </div>
      </div>
    </div>
  `;

  if (!silent) loadRestaurants();
}

async function toggleRestaurant(id) {
  try {
    await fetch(`${API_BASE}/restaurants/toggle/${id}`, { method: 'POST' });
    toast('Status updated');
    loadRestaurants();
  } catch(e) { toast('Failed', 'error'); }
}

async function deleteRestaurant(id) {
  if (!confirm(t('Delete this restaurant? This cannot be undone.'))) return;
  try {
    await fetch(`${API_BASE}/restaurants/${id}`, { method: 'DELETE' });
    selectedId = null;
    toast('Restaurant deleted');
    loadRestaurants();
    document.getElementById('rdetail').innerHTML = `
      <div class="card" style="text-align:center;padding:60px 20px">
        <div style="font-size:40px;margin-bottom:12px;opacity:0.25">ğŸ‘†</div>
        <div style="color:var(--muted);font-size:14px">${t('Select a restaurant to manage it')}</div>
      </div>`;
  } catch(e) { toast('Delete failed', 'error'); }
}

function copyTwilioUrl() {
  const el = document.getElementById('twilioUrl');
  navigator.clipboard.writeText(el.value)
    .then(() => toast('Twilio URL copied'))
    .catch(() => toast('Copy failed', 'error'));
}

// â”€â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendChat() {
  if (!selectedId) { toast('Select a restaurant first', 'error'); return; }
  const msg = document.getElementById('chatMsg').value.trim();
  if (!msg) return;
  const prompt = document.getElementById(`rprompt-${selectedId}`)?.value || '';
  const chatEl = document.getElementById('chat');

  chatEl.innerHTML += `<div class="chat-msg user"><div class="sender">${t('You')}</div><div class="bubble">${esc(msg)}</div></div>`;
  document.getElementById('chatMsg').value = '';
  chatEl.scrollTop = chatEl.scrollHeight;

  const typingId = 'typing-' + Date.now();
  chatEl.innerHTML += `<div class="chat-msg ai" id="${typingId}"><div class="sender">${t('AI')}</div><div class="bubble"><span class="loading"></span></div></div>`;
  chatEl.scrollTop = chatEl.scrollHeight;

  try {
    const r = await fetch(`${API_BASE}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, restaurant_prompt: prompt })
    });
    const data = await r.json();
    if (!r.ok || !data.reply) throw new Error('chat failed');
    document.getElementById(typingId).outerHTML = `<div class="chat-msg ai"><div class="sender">${t('AI')}</div><div class="bubble">${esc(data.reply)}</div></div>`;
  } catch(e) {
    document.getElementById(typingId).outerHTML = `<div class="chat-msg ai"><div class="sender">${t('AI')}</div><div class="bubble" style="color:var(--red)">${t('Server error, we will fix soon.')}</div></div>`;
  }
  chatEl.scrollTop = chatEl.scrollHeight;
}

// â”€â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startVoice() {
  if (!selectedId) { toast('Select a restaurant first', 'error'); return; }
  if (!window.isSecureContext || !navigator.mediaDevices?.getUserMedia) {
    toast('Voice requires HTTPS', 'error'); return;
  }
  const prompt = document.getElementById(`rprompt-${selectedId}`)?.value || '';
  const btn = document.getElementById('voiceBtn');
  try {
    const session = await (await fetch(`${API_BASE}/voice-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ restaurant_prompt: prompt })
    })).json();
    if (!session.client_secret?.value) { toast('Voice session error', 'error'); return; }

    const pc = new RTCPeerConnection();
    const audioEl = document.createElement('audio');
    audioEl.autoplay = true;
    pc.ontrack = e => audioEl.srcObject = e.streams[0];
    (await navigator.mediaDevices.getUserMedia({ audio: true })).getTracks()
      .forEach(track => pc.addTrack(track));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    const sdpRes = await fetch('https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview', {
      method: 'POST', body: offer.sdp,
      headers: { Authorization: `Bearer ${session.client_secret.value}`, 'Content-Type': 'application/sdp' }
    });
    await pc.setRemoteDescription({ type: 'answer', sdp: await sdpRes.text() });
    btn.textContent = `ğŸ”´ ${t('End Voice Session')}`;
    btn.classList.add('active');
    toast('Voice session started');
  } catch(e) { toast('Voice session error', 'error'); }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Apply saved language on load
if (currentLang === 'he') setLang('he');

loadGlobal();
loadRestaurants();
loadStats();
loadLogs();
</script>
</body>
</html>
