<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceIQ â€” Restaurant IVR Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #0a0e1a;
  --surface:   #111827;
  --surface2:  #1a2235;
  --surface3:  #1e2a40;
  --border:    #1f2d42;
  --border2:   #273347;

  --blue:      #3b82f6;
  --blue-dim:  rgba(59,130,246,0.12);
  --blue-glow: rgba(59,130,246,0.25);

  --green:     #22c55e;
  --green-dim: rgba(34,197,94,0.12);

  --red:       #ef4444;
  --red-dim:   rgba(239,68,68,0.12);

  --amber:     #f59e0b;
  --amber-dim: rgba(245,158,11,0.12);

  --purple:    #a78bfa;
  --purple-dim:rgba(167,139,250,0.12);

  --text:      #f1f5f9;
  --text2:     #94a3b8;
  --text3:     #475569;

  --sidebar:   220px;
  --sidebar-sm:68px;
  --radius:    14px;
  --radius-sm: 9px;
  --radius-xs: 6px;
}

*,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }

html { font-size:15px; }

body {
  font-family:'Outfit',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}

body::before {
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse 70% 50% at 0% 0%,    rgba(59,130,246,0.07) 0%,transparent 60%),
    radial-gradient(ellipse 50% 40% at 100% 100%, rgba(167,139,250,0.05) 0%,transparent 60%);
  pointer-events:none;
  z-index:0;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:10px; }
::-webkit-scrollbar-thumb:hover { background:#334155; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  position:fixed;
  inset:0 auto 0 0;
  width:var(--sidebar);
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  z-index:200;
  transition:width .22s cubic-bezier(.4,0,.2,1);
}

.logo {
  padding:22px 18px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:11px;
  min-height:70px;
}

.logo-mark {
  width:36px; height:36px;
  background:linear-gradient(135deg,#3b82f6,#6366f1);
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:17px;
  flex-shrink:0;
  box-shadow:0 0 24px rgba(99,102,241,.35);
}

.logo-text {
  font-weight:800;
  font-size:19px;
  letter-spacing:-.4px;
  white-space:nowrap;
  overflow:hidden;
}

.logo-text em { font-style:normal; color:var(--blue); }

.sidebar-toggle {
  margin-left:auto;
  flex-shrink:0;
  width:28px; height:28px;
  border:1px solid var(--border2);
  border-radius:var(--radius-xs);
  background:transparent;
  color:var(--text3);
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:14px;
  transition:all .15s;
}
.sidebar-toggle:hover { background:var(--surface3); color:var(--text); border-color:#334155; }

.nav {
  flex:1;
  padding:14px 10px;
  display:flex;
  flex-direction:column;
  gap:2px;
  overflow-y:auto;
  overflow-x:hidden;
}

.nav-section {
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  color:var(--text3);
  letter-spacing:1.8px;
  text-transform:uppercase;
  padding:14px 10px 6px;
  white-space:nowrap;
  overflow:hidden;
}

.nav-btn {
  display:flex;
  align-items:center;
  gap:11px;
  width:100%;
  padding:10px 12px;
  background:transparent;
  border:1px solid transparent;
  border-radius:var(--radius-sm);
  color:var(--text2);
  cursor:pointer;
  font-family:'Outfit',sans-serif;
  font-size:14px;
  font-weight:500;
  transition:all .16s;
  text-align:left;
  white-space:nowrap;
  overflow:hidden;
}

.nav-btn:hover { background:var(--surface2); color:var(--text); }

.nav-btn.active {
  background:var(--blue-dim);
  color:#93c5fd;
  border-color:rgba(59,130,246,.2);
}

.nav-icon {
  width:18px; height:18px;
  flex-shrink:0;
  opacity:.65;
}

.nav-btn.active .nav-icon { opacity:1; }

.nav-label { white-space:nowrap; overflow:hidden; }

.nav-badge {
  margin-left:auto;
  background:var(--blue-dim);
  color:var(--blue);
  border:1px solid rgba(59,130,246,.2);
  border-radius:20px;
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  padding:1px 7px;
  flex-shrink:0;
}

.sidebar-footer {
  padding:14px 10px;
  border-top:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:8px;
}

.system-status {
  display:flex;
  align-items:center;
  gap:9px;
  padding:9px 12px;
  background:var(--green-dim);
  border:1px solid rgba(34,197,94,.18);
  border-radius:var(--radius-sm);
  font-size:12px;
  font-weight:500;
  color:var(--green);
  white-space:nowrap;
  overflow:hidden;
}

.pulse-dot {
  width:7px; height:7px;
  background:var(--green);
  border-radius:50%;
  flex-shrink:0;
  box-shadow:0 0 8px var(--green);
  animation:pulseAnim 2s infinite;
}

@keyframes pulseAnim { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.85)} }

.logout-btn {
  display:flex;
  align-items:center;
  gap:9px;
  width:100%;
  padding:9px 12px;
  background:transparent;
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text3);
  cursor:pointer;
  font-family:'Outfit',sans-serif;
  font-size:13px;
  font-weight:500;
  transition:all .15s;
  white-space:nowrap;
  overflow:hidden;
}

.logout-btn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }

/* â”€â”€ COLLAPSED â”€â”€ */
body.collapsed .sidebar { width:var(--sidebar-sm); }
body.collapsed .main    { margin-left:var(--sidebar-sm); }
body.collapsed .logo    { justify-content:center; padding:18px 0; }
body.collapsed .logo-text,
body.collapsed .nav-section,
body.collapsed .nav-label,
body.collapsed .nav-badge,
body.collapsed .system-status span,
body.collapsed .logout-btn span { display:none; }
body.collapsed .sidebar-toggle { margin-left:0; }
body.collapsed .nav-btn  { justify-content:center; padding:10px 0; gap:0; }
body.collapsed .nav-section { padding:10px 0; }
body.collapsed .system-status { justify-content:center; padding:9px 0; }
body.collapsed .logout-btn { justify-content:center; padding:9px 0; gap:0; }

/* â”€â”€ MAIN â”€â”€ */
.main {
  margin-left:var(--sidebar);
  padding:32px 36px;
  min-height:100vh;
  position:relative;
  z-index:1;
  transition:margin-left .22s cubic-bezier(.4,0,.2,1);
  max-width:1400px;
}

/* â”€â”€ PAGES â”€â”€ */
.page { display:none; }
.page.active { display:block; animation:fadeUp .25s ease; }

@keyframes fadeUp {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

/* â”€â”€ PAGE HEADER â”€â”€ */
.page-head { margin-bottom:28px; }

.page-title {
  font-size:24px;
  font-weight:800;
  letter-spacing:-.4px;
}

.page-sub {
  color:var(--text2);
  font-size:13.5px;
  margin-top:4px;
}

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
  gap:14px;
  margin-bottom:24px;
}

.stat-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px 22px;
  position:relative;
  overflow:hidden;
  cursor:default;
  transition:all .2s;
}

.stat-card:hover {
  border-color:var(--blue);
  transform:translateY(-2px);
  box-shadow:0 10px 32px rgba(59,130,246,.1);
}

.stat-card::before {
  content:'';
  position:absolute;
  inset:0 0 auto 0;
  height:2px;
  background:linear-gradient(90deg,var(--blue),transparent);
}

.stat-label {
  font-family:'JetBrains Mono',monospace;
  font-size:10.5px;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:1.2px;
  margin-bottom:12px;
}

.stat-value {
  font-size:30px;
  font-weight:800;
  letter-spacing:-.5px;
  line-height:1;
}

.stat-emoji {
  position:absolute;
  right:18px; top:16px;
  font-size:22px;
  opacity:.18;
}

/* â”€â”€ CARD â”€â”€ */
.card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:24px;
  margin-bottom:18px;
  transition:border-color .2s;
}

.card:hover { border-color:var(--border2); }

.card-head {
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:18px;
}

.card-title {
  font-size:15px;
  font-weight:700;
  letter-spacing:-.2px;
}

.card-icon {
  width:32px; height:32px;
  background:var(--blue-dim);
  border:1px solid rgba(59,130,246,.18);
  border-radius:var(--radius-xs);
  display:flex; align-items:center; justify-content:center;
  font-size:15px;
  flex-shrink:0;
}

.card-actions { margin-left:auto; display:flex; gap:8px; }

/* â”€â”€ SPLIT LAYOUT â”€â”€ */
.split {
  display:grid;
  grid-template-columns:250px 1fr;
  gap:18px;
  align-items:start;
}

/* â”€â”€ RESTAURANT LIST â”€â”€ */
.r-list {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
}

.r-list-head {
  padding:13px 16px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:11px;
  font-family:'JetBrains Mono',monospace;
  color:var(--text3);
  letter-spacing:1px;
  text-transform:uppercase;
}

.r-list-body {
  padding:8px;
  max-height:600px;
  overflow-y:auto;
}

.r-item {
  display:flex;
  align-items:center;
  gap:9px;
  width:100%;
  padding:10px 12px;
  background:transparent;
  border:1px solid transparent;
  border-radius:var(--radius-sm);
  cursor:pointer;
  color:var(--text2);
  font-size:13.5px;
  font-weight:500;
  transition:all .15s;
  text-align:left;
  margin-bottom:2px;
}

.r-item:hover { background:var(--surface2); color:var(--text); }

.r-item.active {
  background:var(--blue-dim);
  border-color:rgba(59,130,246,.2);
  color:#93c5fd;
}

.r-dot {
  width:7px; height:7px;
  border-radius:50%;
  flex-shrink:0;
}

.on  { background:var(--green); box-shadow:0 0 6px var(--green); }
.off { background:var(--text3); }

.r-name { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.r-assign-btn {
  padding:4px 8px;
  border:1px solid var(--border2);
  border-radius:var(--radius-xs);
  background:var(--surface2);
  color:var(--text2);
  font-size:12px;
  cursor:pointer;
  transition:all .15s;
  flex-shrink:0;
}

.r-assign-btn:hover { border-color:var(--blue); color:var(--blue); }

/* â”€â”€ FORMS â”€â”€ */
.form-group { margin-bottom:15px; }

.form-label {
  display:block;
  font-family:'JetBrains Mono',monospace;
  font-size:10.5px;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:.9px;
  margin-bottom:7px;
}

input, textarea, select {
  width:100%;
  padding:11px 14px;
  background:var(--bg);
  border:1px solid var(--border2);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-family:'Outfit',sans-serif;
  font-size:14px;
  outline:none;
  transition:border-color .18s, box-shadow .18s;
}

input:focus, textarea:focus, select:focus {
  border-color:var(--blue);
  box-shadow:0 0 0 3px var(--blue-dim);
}

input::placeholder, textarea::placeholder { color:var(--text3); }

textarea { resize:vertical; min-height:120px; line-height:1.65; }

select { cursor:pointer; }
select option { background:var(--surface); }

.form-row {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:13px;
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display:inline-flex;
  align-items:center;
  gap:7px;
  padding:9px 18px;
  border-radius:var(--radius-sm);
  border:1px solid transparent;
  font-family:'Outfit',sans-serif;
  font-size:13.5px;
  font-weight:600;
  cursor:pointer;
  transition:all .17s;
  white-space:nowrap;
  line-height:1;
}

.btn-primary {
  background:var(--blue);
  color:#fff;
  border-color:var(--blue);
  box-shadow:0 0 20px var(--blue-glow);
}

.btn-primary:hover {
  background:#2563eb;
  box-shadow:0 0 28px rgba(59,130,246,.45);
  transform:translateY(-1px);
}

.btn-secondary {
  background:var(--surface2);
  color:var(--text);
  border-color:var(--border2);
}

.btn-secondary:hover { background:var(--surface3); border-color:#334155; }

.btn-danger {
  background:var(--red-dim);
  color:var(--red);
  border-color:rgba(239,68,68,.2);
}

.btn-danger:hover { background:rgba(239,68,68,.22); border-color:var(--red); }

.btn-success {
  background:var(--green-dim);
  color:var(--green);
  border-color:rgba(34,197,94,.2);
}

.btn-ghost {
  background:transparent;
  color:var(--text2);
  border-color:var(--border);
}

.btn-ghost:hover { background:var(--surface2); color:var(--text); }

.btn-sm { padding:7px 13px; font-size:12.5px; }
.btn-xs { padding:5px 10px; font-size:12px; }

.btn-icon {
  width:32px; height:32px;
  padding:0;
  justify-content:center;
  border:1px solid var(--border2);
  background:var(--surface2);
  color:var(--text2);
  border-radius:var(--radius-xs);
}

.btn-icon:hover { border-color:#334155; color:var(--text); }

.btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap { overflow-x:auto; }

table.tbl {
  width:100%;
  border-collapse:collapse;
}

.tbl thead tr { border-bottom:1px solid var(--border); }

.tbl th {
  padding:10px 14px;
  text-align:left;
  font-family:'JetBrains Mono',monospace;
  font-size:10.5px;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:.9px;
  font-weight:400;
  white-space:nowrap;
}

.tbl td {
  padding:13px 14px;
  font-size:13.5px;
  border-bottom:1px solid rgba(31,45,66,.5);
  color:#cbd5e1;
  vertical-align:middle;
}

.tbl tbody tr:last-child td { border-bottom:none; }
.tbl tbody tr:hover td { background:rgba(255,255,255,.02); }

/* â”€â”€ BADGES â”€â”€ */
.badge {
  display:inline-flex;
  align-items:center;
  gap:5px;
  padding:3px 9px;
  border-radius:20px;
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  font-weight:500;
  white-space:nowrap;
}

.badge-green  { background:var(--green-dim); color:var(--green); border:1px solid rgba(34,197,94,.2); }
.badge-red    { background:var(--red-dim);   color:var(--red);   border:1px solid rgba(239,68,68,.2); }
.badge-amber  { background:var(--amber-dim); color:var(--amber); border:1px solid rgba(245,158,11,.2); }
.badge-blue   { background:var(--blue-dim);  color:#93c5fd;      border:1px solid rgba(59,130,246,.2); }
.badge-purple { background:var(--purple-dim);color:var(--purple);border:1px solid rgba(167,139,250,.2); }

/* â”€â”€ CHAT â”€â”€ */
.chat-box {
  height:210px;
  overflow-y:auto;
  background:var(--bg);
  border:1px solid var(--border2);
  border-radius:var(--radius-sm);
  padding:14px;
  margin-bottom:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg { display:flex; flex-direction:column; gap:3px; }

.msg-sender {
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:1.2px;
  color:var(--text3);
}

.msg.user { align-items:flex-end; }
.msg.user .msg-sender { color:var(--blue); }
.msg.ai   { align-items:flex-start; }
.msg.ai   .msg-sender { color:var(--green); }

.msg-bubble {
  padding:9px 13px;
  border-radius:10px;
  font-size:13.5px;
  line-height:1.55;
  max-width:90%;
}

.msg.user .msg-bubble {
  background:var(--blue-dim);
  border:1px solid rgba(59,130,246,.18);
}

.msg.ai .msg-bubble {
  background:var(--surface2);
  border:1px solid var(--border2);
}

.chat-row { display:flex; gap:8px; }
.chat-row input { flex:1; }

/* â”€â”€ VOICE â”€â”€ */
.voice-btn {
  width:100%;
  padding:14px;
  background:var(--green-dim);
  border:1px solid rgba(34,197,94,.2);
  border-radius:var(--radius-sm);
  color:var(--green);
  cursor:pointer;
  font-family:'Outfit',sans-serif;
  font-size:14px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:9px;
  transition:all .18s;
  margin-top:8px;
}

.voice-btn:hover {
  background:rgba(34,197,94,.18);
  box-shadow:0 0 20px rgba(34,197,94,.15);
}

.voice-btn.active {
  background:var(--red-dim);
  border-color:rgba(239,68,68,.3);
  color:var(--red);
}

/* â”€â”€ TWILIO BOX â”€â”€ */
.twilio-row { display:flex; gap:9px; align-items:center; }
.twilio-row input { flex:1; font-family:'JetBrains Mono',monospace; font-size:12px; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty {
  text-align:center;
  padding:52px 20px;
  color:var(--text3);
}

.empty-icon { font-size:36px; margin-bottom:10px; opacity:.35; }
.empty-text { font-size:13.5px; }

/* â”€â”€ SECTION LABEL â”€â”€ */
.section-lbl {
  font-family:'JetBrains Mono',monospace;
  font-size:10.5px;
  color:var(--text3);
  text-transform:uppercase;
  letter-spacing:1.4px;
  margin-bottom:13px;
  display:flex;
  align-items:center;
  gap:10px;
}

.section-lbl::after { content:''; flex:1; height:1px; background:var(--border); }

/* â”€â”€ LOADING â”€â”€ */
.spin {
  display:inline-block;
  width:14px; height:14px;
  border:2px solid rgba(59,130,246,.3);
  border-top-color:var(--blue);
  border-radius:50%;
  animation:spin .65s linear infinite;
}

@keyframes spin { to { transform:rotate(360deg); } }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position:fixed;
  bottom:22px;
  right:22px;
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--radius-sm);
  padding:11px 18px;
  font-size:13.5px;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:9999;
  opacity:0;
  transform:translateY(8px);
  transition:all .28s cubic-bezier(.4,0,.2,1);
  pointer-events:none;
  box-shadow:0 10px 36px rgba(0,0,0,.45);
  max-width:320px;
}

#toast.show { opacity:1; transform:translateY(0); }
#toast.ok   { border-left:3px solid var(--green); }
#toast.err  { border-left:3px solid var(--red); }
#toast.ok .toast-icon::before { content:'âœ“'; color:var(--green); }
#toast.err .toast-icon::before { content:'âœ•'; color:var(--red); }
.toast-icon { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:700; }

/* â”€â”€ AUTH OVERLAY â”€â”€ */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(5,8,18,.85);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
}

.overlay.hidden { display:none; }

.auth-card {
  width:min(400px,93vw);
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:28px;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

.auth-logo {
  width:42px; height:42px;
  background:linear-gradient(135deg,#3b82f6,#6366f1);
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px;
  margin-bottom:18px;
  box-shadow:0 0 24px rgba(99,102,241,.35);
}

.auth-title { font-size:22px; font-weight:800; letter-spacing:-.3px; margin-bottom:5px; }
.auth-sub   { font-size:13px; color:var(--text2); margin-bottom:20px; }
.auth-err   { color:var(--red); font-size:12.5px; margin-top:8px; min-height:16px; }

/* â”€â”€ EDIT USER MODAL â”€â”€ */
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(5,8,18,.75);
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9000;
}

.modal-overlay.hidden { display:none; }

.modal-card {
  width:min(440px,93vw);
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:26px;
  box-shadow:0 16px 50px rgba(0,0,0,.5);
}

.modal-title { font-size:18px; font-weight:700; margin-bottom:4px; }
.modal-sub   { font-size:13px; color:var(--text2); margin-bottom:18px; }
.modal-actions { display:flex; gap:9px; justify-content:flex-end; margin-top:6px; }
.modal-err { color:var(--red); font-size:12.5px; margin-top:8px; min-height:16px; }

/* â”€â”€ LANG SWITCH â”€â”€ */
#lang-switch {
  position:fixed;
  top:14px; right:14px;
  z-index:10100;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:var(--radius-xs);
  display:flex;
  overflow:hidden;
}

.lang-opt {
  padding:6px 12px;
  background:transparent;
  border:none;
  color:var(--text3);
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  cursor:pointer;
  transition:all .14s;
}

.lang-opt:hover { background:var(--surface3); color:var(--text); }
.lang-opt.on { background:var(--blue-dim); color:#93c5fd; }
.lang-divider { width:1px; background:var(--border); }

/* â”€â”€ ADMIN USERS LIST â”€â”€ */
.admin-user-row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:11px 14px;
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  margin-bottom:8px;
  gap:10px;
}

.admin-user-info { display:flex; flex-direction:column; gap:2px; }
.admin-user-email { font-size:13.5px; font-weight:500; }
.admin-user-status { font-size:11px; color:var(--text3); }

.admin-user-btns { display:flex; gap:7px; flex-wrap:wrap; }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 900px) {
  .split { grid-template-columns:1fr; }
  .form-row { grid-template-columns:1fr; }
  .main { padding:20px; }
}

@media (max-width: 640px) {
  .stats-grid { grid-template-columns:1fr 1fr; }
  .sidebar { display:none; }
  .main { margin-left:0; }
}
</style>
</head>
<body>

<!-- Lang -->
<div id="lang-switch">
  <button class="lang-opt on" onclick="setLang('en')">EN</button>
  <div class="lang-divider"></div>
  <button class="lang-opt" onclick="setLang('he')">×¢×‘</button>
</div>

<!-- Auth -->
<div id="authOverlay" class="overlay hidden">
  <div class="auth-card">
    <div class="auth-logo">ğŸ™ï¸</div>
    <div class="auth-title" data-i18n="Sign in">Sign in</div>
    <div class="auth-sub" data-i18n="Sign in to continue">Sign in to your VoiceIQ account</div>
    <div class="form-group">
      <label class="form-label" data-i18n="Email">Email</label>
      <input id="authEmail" type="email" placeholder="admin@example.com">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="Password">Password</label>
      <input id="authPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="login()">
      Sign in â†’
    </button>
    <div id="authErr" class="auth-err"></div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserOverlay" class="modal-overlay hidden">
  <div class="modal-card">
    <div class="modal-title" data-i18n="Edit User">Edit User</div>
    <div class="modal-sub" data-i18n="Update email and password for this user">Update credentials for this user</div>
    <div class="form-group">
      <label class="form-label" data-i18n="Admin Email">Email</label>
      <input id="editEmail" type="email" placeholder="manager@example.com">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="New Password (optional)">New Password (leave blank to keep current)</label>
      <input id="editPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div id="editErr" class="modal-err"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" onclick="closeEditUser()" data-i18n="Cancel">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveEditUser()" data-i18n="Save Changes">Save Changes</button>
    </div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar">
  <div class="logo">
    <div class="logo-mark">ğŸ™ï¸</div>
    <div class="logo-text">Voice<em>IQ</em></div>
    <button class="sidebar-toggle" id="toggleBtn" onclick="toggleSidebar()">â€¹</button>
  </div>

  <div class="nav">
    <div class="nav-section" data-i18n="Platform">Platform</div>

    <button class="nav-btn active" onclick="show('dash',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span class="nav-label" data-i18n="Dashboard">Dashboard</span>
    </button>

    <button class="nav-btn" id="navGlobal" onclick="show('global',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15 15 0 0 1 4 10 15 15 0 0 1-4 10 15 15 0 0 1-4-10 15 15 0 0 1 4-10z"/></svg>
      <span class="nav-label" data-i18n="Global Prompt">Global Prompt</span>
    </button>

    <button class="nav-btn" id="navRest" onclick="show('restaurants',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
      <span class="nav-label" data-i18n="Restaurants">Restaurants</span>
    </button>

    <button class="nav-btn" onclick="show('orders',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></svg>
      <span class="nav-label" data-i18n="Orders">Orders</span>
    </button>

    <button class="nav-btn" onclick="show('logs',this)">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.6 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6a16 16 0 0 0 6.29 6.29l.96-.96a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
      <span class="nav-label" data-i18n="Call Logs">Call Logs</span>
    </button>
  </div>

  <div class="sidebar-footer">
    <div class="system-status">
      <div class="pulse-dot"></div>
      <span data-i18n="System Online">System Online</span>
    </div>
    <button class="logout-btn" onclick="logout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      <span data-i18n="Logout">Logout</span>
    </button>
  </div>
</nav>

<!-- Main -->
<main class="main">

  <!-- Dashboard -->
  <div id="dash" class="page active">
    <div class="page-head">
      <div class="page-title">Dashboard</div>
      <div class="page-sub">Real-time overview of your IVR platform</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Active Restaurants</div>
        <div class="stat-value" id="sRest">â€”</div>
        <div class="stat-emoji">ğŸ½ï¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Calls</div>
        <div class="stat-value" id="sCalls">â€”</div>
        <div class="stat-emoji">ğŸ“</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Missed Calls</div>
        <div class="stat-value" id="sMissed">â€”</div>
        <div class="stat-emoji">ğŸ“µ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Duration</div>
        <div class="stat-value" id="sDur">â€”</div>
        <div class="stat-emoji">â±ï¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">API Usage</div>
        <div class="stat-value" id="sUsage">0</div>
        <div class="stat-emoji">ğŸ”Œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Est. Cost</div>
        <div class="stat-value" id="sCost">$0.00</div>
        <div class="stat-emoji">ğŸ’³</div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ“‹</div>
        <div class="card-title">Recent Activity</div>
      </div>
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr>
            <th>Restaurant</th><th>Caller</th><th>Status</th><th>Duration</th><th>Date</th>
          </tr></thead>
          <tbody id="recentLogs">
            <tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">No recent calls</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Global Prompt -->
  <div id="global" class="page">
    <div class="page-head">
      <div class="page-title">Global Prompt</div>
      <div class="page-sub">This prompt applies to every restaurant on the platform</div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸŒ</div>
        <div class="card-title">Base System Prompt</div>
        <div class="card-actions">
          <button class="btn btn-primary btn-sm" onclick="saveGlobal()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
            Save
          </button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Prompt Content</label>
        <textarea id="globalPrompt" style="min-height:200px"></textarea>
      </div>
    </div>

    <div class="card" style="border-color:rgba(59,130,246,.2);background:var(--blue-dim)">
      <div class="card-head">
        <div class="card-icon">ğŸ’¡</div>
        <div class="card-title">How it works</div>
      </div>
      <p style="font-size:13.5px;color:var(--text2);line-height:1.75">
        The global prompt sets the baseline personality and rules for all your restaurant AI assistants.
        Each restaurant's individual IVR prompt is appended after this, allowing customization per location.
      </p>
    </div>
  </div>

  <!-- Restaurants -->
  <div id="restaurants" class="page">
    <div class="page-head">
      <div class="page-title">Restaurants</div>
      <div class="page-sub">Manage your connected restaurant profiles and IVR configurations</div>
    </div>

    <div class="split">
      <!-- Left list -->
      <div>
        <div class="r-list">
          <div class="r-list-head">
            <span>Locations</span>
            <button id="createBtn" class="btn-icon" onclick="toggleCreate()" title="Add restaurant">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
          </div>
          <div class="r-list-body" id="rlist">
            <div class="empty" style="padding:30px 16px">
              <div class="empty-icon">ğŸ½ï¸</div>
              <div class="empty-text">No restaurants yet</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right pane -->
      <div id="rightPane">
        <div id="createBox" class="card" style="display:none">
          <div class="card-head">
            <div class="card-icon">â•</div>
            <div class="card-title">New Restaurant</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Restaurant Name</label>
              <input id="rname" placeholder="e.g. Bella Italia">
            </div>
            <div class="form-group">
              <label class="form-label">Phone Number</label>
              <input id="rphone" placeholder="+1 (555) 000-0000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">IVR Prompt</label>
            <textarea id="rprompt" placeholder="Custom instructions for this location..."></textarea>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="addRestaurant()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Create Restaurant
            </button>
          </div>
        </div>

        <div id="assignBox" class="card" style="display:none">
          <div class="card-head">
            <div class="card-icon">ğŸ‘¤</div>
            <div class="card-title">Assign Admin</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Admin Email</label>
              <input id="adminEmail" placeholder="manager@example.com">
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input id="adminPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Restaurant</label>
            <select id="adminRestaurant"></select>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="createOrAssignAdmin()">Create / Assign</button>
          </div>
          <p style="font-size:12px;color:var(--text3);margin-top:10px">
            If the user already exists, we'll just assign them. Otherwise we create a new account.
          </p>
        </div>

        <div id="rdetail">
          <div class="card" style="text-align:center;padding:60px 24px">
            <div style="font-size:42px;margin-bottom:12px;opacity:.18">ğŸ‘†</div>
            <div style="color:var(--text3);font-size:14px">Select a restaurant to manage it</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders -->
  <div id="orders" class="page">
    <div class="page-head">
      <div class="page-title">Orders</div>
      <div class="page-sub">Reservation data captured from voice calls</div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ“¦</div>
        <div class="card-title">All Reservations</div>
      </div>
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr>
            <th>#</th><th>Restaurant</th><th>Customer</th><th>Type</th>
            <th>Date</th><th>Time</th><th>Guests</th><th>Phone</th>
            <th>Recording</th><th>Status</th><th>Created</th><th>Actions</th>
          </tr></thead>
          <tbody id="orderTable">
            <tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">No orders yet</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Call Logs -->
  <div id="logs" class="page">
    <div class="page-head">
      <div class="page-title">Call Logs</div>
      <div class="page-sub">Complete history of all IVR interactions</div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ“</div>
        <div class="card-title">All Calls</div>
      </div>
      <div class="tbl-wrap">
        <table class="tbl">
          <thead><tr>
            <th>#</th><th>Restaurant</th><th>Caller</th><th>Status</th><th>Duration</th><th>Date</th>
          </tr></thead>
          <tbody id="logTable">
            <tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ“µ</div><div class="empty-text">No calls recorded yet</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<!-- Toast -->
<div id="toast">
  <div class="toast-icon"></div>
  <span id="toastMsg"></span>
</div>

<script>
// â”€â”€â”€ I18N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HE = {
  "Sign in":"×”×ª×—×‘×¨","Sign in to continue":"×”×ª×—×‘×¨ ×œ×—×©×‘×•×Ÿ ×©×œ×š","Email":"××™××™×™×œ","Password":"×¡×™×¡××”",
  "Dashboard":"×œ×•×— ×‘×§×¨×”","Global Prompt":"×¤×¨×•××¤×˜ ×’×œ×•×‘×œ×™","Restaurants":"××¡×¢×“×•×ª",
  "Orders":"×”×–×× ×•×ª","Call Logs":"×™×•××Ÿ ×©×™×—×•×ª","System Online":"××¢×¨×›×ª ×¤×¢×™×œ×”",
  "Logout":"×™×¦×™××”","Platform":"×¤×œ×˜×¤×•×¨××”","Edit User":"×¢×¨×™×›×ª ××©×ª××©",
  "Update email and password for this user":"×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×”×›× ×™×¡×”",
  "Admin Email":"××™××™×™×œ ×× ×”×œ","New Password (optional)":"×¡×™×¡××” ×—×“×©×” (××•×¤×¦×™×•× ×œ×™)",
  "Cancel":"×‘×™×˜×•×œ","Save Changes":"×©××•×¨ ×©×™× ×•×™×™×"
};

let lang = localStorage.getItem('ui_lang') || 'en';

function t(k) { return lang === 'he' && HE[k] ? HE[k] : k; }

function setLang(l) {
  lang = l;
  localStorage.setItem('ui_lang', l);
  const isHe = l === 'he';
  document.documentElement.dir = isHe ? 'rtl' : 'ltr';
  document.body.dir = isHe ? 'rtl' : 'ltr';
  document.querySelectorAll('.lang-opt').forEach(b =>
    b.classList.toggle('on', b.textContent.trim() === (isHe ? '×¢×‘' : 'EN')));
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    const tr = t(k);
    if (tr !== k || l === 'en') el.textContent = tr;
  });
}

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = (() => {
  const saved = (localStorage.getItem('apiBaseUrl') || '').trim().replace(/\/+$/,'');
  if (saved) return saved;
  const isLocal8k = ['localhost','127.0.0.1','::1'].includes(location.hostname) && location.port === '8000';
  return isLocal8k
    ? location.origin.replace(':8000', ':5050') + '/api'
    : location.origin + '/api';
})();

let token   = localStorage.getItem('auth_token') || '';
let me      = null;
let rCache  = [];
let oCache  = [];
let uCache  = [];
let selId   = null;
let editUid = null;
let assignOpen = false;
let assignRid  = null;
let collapsed  = localStorage.getItem('sb_col') === '1';
let inited  = false;

const ORDER_MARKER = 'ORDER_JSON:';
let oc = { buf:'', tail:'', done:false };

let vs = { pc:null, stream:null, audio:null, dc:null, on:false };

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const h = { ...(opts.headers || {}) };
  if (token) h.Authorization = `Bearer ${token}`;
  const r = await fetch(path, { ...opts, headers:h });
  if (r.status === 401) {
    token = '';
    localStorage.removeItem('auth_token');
    showAuth('Sign in to continue');
    throw new Error('Unauthorized');
  }
  return r;
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAuth(msg) {
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('authErr').textContent = msg || '';
}

function hideAuth() {
  document.getElementById('authOverlay').classList.add('hidden');
  document.getElementById('authErr').textContent = '';
}

async function login() {
  const email = document.getElementById('authEmail').value.trim();
  const pass  = document.getElementById('authPassword').value;
  const err   = document.getElementById('authErr');
  err.textContent = '';
  if (!email || !pass) { err.textContent = 'Please fill in all fields'; return; }
  try {
    const r = await fetch(`${API_BASE}/auth/login`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email, password:pass })
    });
    const d = await r.json();
    if (!r.ok || !d.token) throw new Error();
    token = d.token;
    localStorage.setItem('auth_token', token);
    hideAuth();
    await boot();
  } catch { err.textContent = 'Invalid email or password'; }
}

document.getElementById('authPassword').addEventListener('keydown', e => e.key === 'Enter' && login());

async function logout() {
  try { if (token) await api(`${API_BASE}/auth/logout`, { method:'POST' }); } catch {}
  token = '';
  localStorage.removeItem('auth_token');
  inited = false;
  showAuth('');
}

async function checkAuth() {
  if (!token) { showAuth(); return false; }
  try {
    const r = await api(`${API_BASE}/auth/me`);
    me = await r.json();
    applyRole();
    return true;
  } catch { showAuth(); return false; }
}

function applyRole() {
  const admin = !!me?.is_admin;
  document.getElementById('navGlobal').style.display = admin ? '' : 'none';
  document.getElementById('createBtn').style.display = admin ? '' : 'none';
}

// â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  collapsed = !collapsed;
  localStorage.setItem('sb_col', collapsed ? '1' : '0');
  document.body.classList.toggle('collapsed', collapsed);
  document.getElementById('toggleBtn').textContent = collapsed ? 'â€º' : 'â€¹';
}

// â”€â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (id === 'logs')        loadLogs();
  if (id === 'orders')      loadOrders();
  if (id === 'restaurants') loadRestaurants();
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, type = 'ok') {
  clearTimeout(toastTimer);
  const el = document.getElementById('toast');
  el.className = `show ${type}`;
  document.getElementById('toastMsg').textContent = msg;
  toastTimer = setTimeout(() => { el.className = ''; }, 3200);
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const esc = v => String(v ?? '').replace(/[&<>"']/g, m =>
  ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function fmtDur(s) {
  s = Math.max(0, Math.round(Number(s) || 0));
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  if (h) return `${h}h ${m}m`;
  if (m) return `${m}m ${sec}s`;
  return `${sec}s`;
}

function statusBadge(s) {
  if (!s) return `<span class="badge badge-amber">Unknown</span>`;
  const sl = s.toLowerCase();
  if (sl.includes('answer') || sl.includes('complet')) return `<span class="badge badge-green">${esc(s)}</span>`;
  if (sl.includes('miss') || sl.includes('fail'))      return `<span class="badge badge-red">${esc(s)}</span>`;
  return `<span class="badge badge-blue">${esc(s)}</span>`;
}

function orderStatusBadge(s) {
  if (!s) return `<span class="badge badge-amber">Unknown</span>`;
  const sl = s.toLowerCase();
  if (sl.includes('complet')) return `<span class="badge badge-green">${esc(s)}</span>`;
  if (sl.includes('incompl')) return `<span class="badge badge-amber">${esc(s)}</span>`;
  return `<span class="badge badge-blue">${esc(s)}</span>`;
}

function monospace(v) {
  return `<span style="font-family:'JetBrains Mono',monospace;font-size:12px">${esc(v)}</span>`;
}

function dim(v) { return `<span style="color:var(--text3);font-family:'JetBrains Mono',monospace;font-size:11.5px">${esc(v)}</span>`; }

// â”€â”€â”€ GLOBAL PROMPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGlobal() {
  try {
    const r = await api(`${API_BASE}/prompt/`);
    const d = await r.json();
    document.getElementById('globalPrompt').value = d.prompt || '';
  } catch {}
}

async function saveGlobal() {
  try {
    await api(`${API_BASE}/prompt/save`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ content: document.getElementById('globalPrompt').value })
    });
    toast('Global prompt saved âœ“');
  } catch { toast('Save failed', 'err'); }
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const s = await (await api(`${API_BASE}/dashboard/stats`)).json();
    document.getElementById('sRest').textContent   = s.restaurants ?? 0;
    document.getElementById('sCalls').textContent  = s.calls ?? 0;
    document.getElementById('sMissed').textContent = s.missed ?? 0;
    document.getElementById('sDur').textContent    = fmtDur(s.total_duration ?? 0);
  } catch {}
}

// â”€â”€â”€ LOGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLogs() {
  try {
    const logs = await (await api(`${API_BASE}/calls/`)).json();
    const tbody = document.getElementById('logTable');
    const recent = document.getElementById('recentLogs');
    if (!logs.length) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ“µ</div><div class="empty-text">No calls recorded yet</div></div></td></tr>`;
      return;
    }
    const row = l => `<tr>
      <td>${dim('#' + l.id)}</td>
      <td style="font-weight:500">${esc(l.restaurant)}</td>
      <td>${monospace(l.caller)}</td>
      <td>${statusBadge(l.status)}</td>
      <td>${monospace(fmtDur(l.duration))}</td>
      <td>${dim(l.created)}</td>
    </tr>`;
    tbody.innerHTML  = logs.map(row).join('');
    recent.innerHTML = logs.slice(0,5).map(l => `<tr>
      <td style="font-weight:500">${esc(l.restaurant)}</td>
      <td>${monospace(l.caller)}</td>
      <td>${statusBadge(l.status)}</td>
      <td>${monospace(fmtDur(l.duration))}</td>
      <td>${dim(l.created)}</td>
    </tr>`).join('');
  } catch {}
}

// â”€â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recUrl(url) {
  const s = String(url || '').trim();
  if (!s) return '';
  if (/^https?:\/\//i.test(s)) return s;
  if (s.startsWith('/')) {
    try { return new URL(API_BASE, location.origin).origin + s; } catch { return s; }
  }
  return s;
}

async function loadOrders() {
  try {
    const orders = await (await api(`${API_BASE}/orders/`)).json();
    oCache = Array.isArray(orders) ? orders : [];
    const tbody = document.getElementById('orderTable');
    if (!oCache.length) {
      tbody.innerHTML = `<tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">No orders yet</div></div></td></tr>`;
      return;
    }
    tbody.innerHTML = oCache.map(o => {
      const dateArrival  = o['date-arrival'] || o.date_arrival  || o.address        || '';
      const timeArrival  = o.time_arrival   || o['time-arrival'] || o.house_number   || '';
      const totalPeoples = o.total_peoples  ?? o.ordered_items  ?? '';
      const contact      = o.contact_number || o.payment_method || '';
      const rec          = recUrl(o.recording_url);
      const recCell      = rec
        ? `<audio controls preload="none" src="${esc(rec)}" style="width:170px;height:28px"></audio>`
        : `<span style="color:var(--text3)">â€”</span>`;
      return `<tr>
        <td>${dim('#' + o.id)}</td>
        <td style="font-weight:500">${esc(o.restaurant)}</td>
        <td>${monospace(o.full_name)}</td>
        <td><span class="badge badge-purple">${esc(o.order_type)}</span></td>
        <td>${monospace(dateArrival)}</td>
        <td>${monospace(timeArrival)}</td>
        <td>${monospace(totalPeoples)}</td>
        <td>${monospace(contact)}</td>
        <td>${recCell}</td>
        <td>${orderStatusBadge(o.status)}</td>
        <td>${dim(o.created)}</td>
        <td>
          <div style="display:flex;gap:6px">
            <button class="btn btn-secondary btn-xs" onclick="editOrder(${o.id})">Edit</button>
            <button class="btn btn-danger btn-xs" onclick="deleteOrder(${o.id})">Delete</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  } catch {}
}

async function editOrder(id) {
  const o = oCache.find(x => Number(x.id) === Number(id));
  if (!o) { toast('Order not found', 'err'); return; }
  const fn  = prompt('Customer name',   o.full_name ?? '');     if (fn  === null) return;
  const da  = prompt('Arrival date',    o.address ?? '');       if (da  === null) return;
  const ta  = prompt('Arrival time',    o.house_number ?? '');  if (ta  === null) return;
  const tp  = prompt('Total people',    o.ordered_items ?? ''); if (tp  === null) return;
  const cn  = prompt('Contact number',  o.payment_method ?? '');if (cn  === null) return;
  const st  = prompt('Status',          o.status ?? 'completed');if (st === null) return;
  try {
    const r = await api(`${API_BASE}/orders/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ full_name:fn, date_arrival:da, time_arrival:ta, total_peoples:tp, contact_number:cn, status:st })
    });
    if (!r.ok) throw new Error();
    toast('Order updated âœ“');
    loadOrders();
  } catch { toast('Update failed', 'err'); }
}

async function deleteOrder(id) {
  if (!confirm(`Delete order #${id}? This cannot be undone.`)) return;
  try {
    const r = await api(`${API_BASE}/orders/${id}`, { method:'DELETE' });
    if (!r.ok) throw new Error();
    toast('Order deleted');
    loadOrders();
  } catch { toast('Delete failed', 'err'); }
}

// â”€â”€â”€ ORDER CAPTURE (from realtime events) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetOC() { oc = { buf:'', tail:'', done:false }; }

function pickFirst(d, ...keys) {
  for (const k of keys) if (d && k in d) return d[k];
  return null;
}

function cleanField(v) {
  const s = String(v ?? '').trim();
  return ['','none','null','n/a','na','unknown'].includes(s.toLowerCase()) ? '' : s;
}

function normalizeOC(data) {
  const fn = cleanField(pickFirst(data,'full_name','fullName','name','customer_name'));
  const da = cleanField(pickFirst(data,'date-arrival','date_arrival','arrival_date','dateArrival'));
  const ta = cleanField(pickFirst(data,'time_arrival','arrival_time','timeArrival','time'));
  const cn = cleanField(pickFirst(data,'contact_number','contactNumber','phone','phone_number'));
  const rt = pickFirst(data,'total_peoples','total_people','people','party_size');
  const digits = cleanField(rt).replace(/\D/g,'');
  const tp = digits ? Number(digits) : (Number.isInteger(rt) ? rt : 0);
  const missing = [];
  if (!fn) missing.push('full_name');
  if (!da) missing.push('date-arrival');
  if (!ta) missing.push('time_arrival');
  if (!cn) missing.push('contact_number');
  if (!tp) missing.push('total_peoples');
  return { data:{order_type:'reservation',full_name:fn,'date-arrival':da,time_arrival:ta,total_peoples:tp,contact_number:cn}, missing };
}

function parseOCBuf(buf) {
  const mi = buf.indexOf(ORDER_MARKER);
  if (mi < 0) return null;
  let tail = buf.slice(mi + ORDER_MARKER.length).trimStart();
  if (tail.startsWith('```')) { const nl = tail.indexOf('\n'); tail = nl !== -1 ? tail.slice(nl+1) : tail.slice(3); }
  const st = tail.indexOf('{');
  if (st < 0) return null;
  let depth=0, end=-1;
  for (let i=st; i<tail.length; i++) {
    if (tail[i]==='{') depth++;
    else if (tail[i]==='}') { depth--; if (!depth) { end=i; break; } }
  }
  if (end<0) return null;
  try { const d = JSON.parse(tail.slice(st,end+1)); return { raw: tail.slice(st,end+1), data: d }; }
  catch { return null; }
}

function extractTexts(evt) {
  if (!evt || typeof evt !== 'object') return [];
  const t2 = String(evt.type||'');
  if (t2==='response.output_audio.delta'||t2==='response.audio.delta') return [];
  const out = [];
  const add = v => { if (typeof v==='string'&&v) out.push(v); };
  ['delta','text','transcript'].forEach(k => add(evt[k]));
  ['item','response'].forEach(k => {
    const n = evt[k];
    if (!n||typeof n!=='object') return;
    ['text','transcript'].forEach(nk => add(n[nk]));
    (n.content||[]).forEach(p => { if (p&&typeof p==='object') ['text','transcript'].forEach(pk => add(p[pk])); });
  });
  if (t2==='response.done') {
    for (const item of ((evt.response||{}).output||[])) {
      if (!item||typeof item!=='object') continue;
      for (const p of (item.content||[])) {
        if (p&&typeof p==='object') ['text','transcript'].forEach(pk => add(p[pk]));
      }
    }
  }
  return out;
}

async function ingestOrder(data, raw) {
  if (!selId) return;
  const r = await api(`${API_BASE}/orders/ingest`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ restaurant_id:selId, ...data, raw_json:raw })
  });
  if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.detail||'failed'); }
}

function handleRTEvent(raw) {
  if (oc.done) return;
  let evt;
  try { evt = JSON.parse(raw); } catch { return; }
  for (const text of extractTexts(evt)) {
    if (!text) continue;
    if (oc.buf) {
      oc.buf += text;
    } else {
      const combined = oc.tail + text;
      if (!combined.includes(ORDER_MARKER)) {
        oc.tail = combined.slice(-(ORDER_MARKER.length-1));
        continue;
      }
      oc.buf = combined.slice(combined.indexOf(ORDER_MARKER));
    }
    if (oc.buf.length > 10000) oc.buf = oc.buf.slice(-10000);
    const parsed = parseOCBuf(oc.buf);
    if (!parsed) continue;
    const { data, missing } = normalizeOC(parsed.data);
    if (missing.length) { oc.buf=''; oc.tail=''; continue; }
    ingestOrder(data, parsed.raw)
      .then(() => { oc.done=true; toast('Reservation saved âœ“'); if (document.getElementById('orders').classList.contains('active')) loadOrders(); })
      .catch(() => toast('Order save failed', 'err'));
    break;
  }
}

// â”€â”€â”€ RESTAURANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRestaurants() {
  try {
    const data = await (await api(`${API_BASE}/restaurants/`)).json();
    rCache = data;
    if (me?.is_admin) populateRestaurantSelect();
    const list = document.getElementById('rlist');
    if (!data.length) {
      list.innerHTML = `<div class="empty" style="padding:30px 16px"><div class="empty-icon">ğŸ½ï¸</div><div class="empty-text">No restaurants yet</div></div>`;
      return;
    }
    const admin = !!me?.is_admin;
    list.innerHTML = data.map(r => `
      <div class="r-item ${r.id===selId?'active':''}" id="ri-${r.id}">
        <div class="r-dot ${r.active?'on':'off'}"></div>
        <span class="r-name" onclick="openR(${r.id})">${esc(r.name||'Unnamed')}</span>
        ${admin ? `<button class="r-assign-btn" onclick="showAssign(${r.id})" title="Manage admins">ğŸ‘¤</button>` : ''}
      </div>`).join('');
    if (selId) openR(selId, true);
  } catch {}
}

function populateRestaurantSelect() {
  const s = document.getElementById('adminRestaurant');
  if (!s) return;
  s.innerHTML = rCache.map(r => `<option value="${r.id}">${esc(r.name||'Unnamed')}</option>`).join('');
}

async function addRestaurant() {
  const name = document.getElementById('rname').value.trim();
  if (!name) { toast('Name is required', 'err'); return; }
  try {
    await api(`${API_BASE}/restaurants/add`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ name, phone:document.getElementById('rphone').value.trim(), ivr_text:document.getElementById('rprompt').value })
    });
    ['rname','rphone','rprompt'].forEach(id => document.getElementById(id).value = '');
    toast(`"${name}" added âœ“`);
    loadRestaurants();
  } catch { toast('Failed to add', 'err'); }
}

function toggleCreate() {
  const b = document.getElementById('createBox');
  b.style.display = b.style.display==='none' ? 'block' : 'none';
}

async function updateR(id) {
  try {
    await api(`${API_BASE}/restaurants/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:   document.getElementById(`rn-${id}`).value.trim(),
        phone:  document.getElementById(`rp-${id}`).value.trim(),
        ivr_text: document.getElementById(`rpr-${id}`).value
      })
    });
    toast('Saved âœ“');
    loadRestaurants();
  } catch { toast('Save failed', 'err'); }
}

async function toggleR(id) {
  try {
    await api(`${API_BASE}/restaurants/toggle/${id}`, { method:'POST' });
    toast('Status updated');
    loadRestaurants();
  } catch { toast('Failed', 'err'); }
}

async function deleteR(id) {
  if (!confirm('Delete this restaurant? This cannot be undone.')) return;
  try {
    await api(`${API_BASE}/restaurants/${id}`, { method:'DELETE' });
    selId = null;
    toast('Deleted');
    loadRestaurants();
    document.getElementById('rdetail').innerHTML = `
      <div class="card" style="text-align:center;padding:60px 24px">
        <div style="font-size:42px;margin-bottom:12px;opacity:.18">ğŸ‘†</div>
        <div style="color:var(--text3);font-size:14px">Select a restaurant to manage it</div>
      </div>`;
  } catch { toast('Delete failed', 'err'); }
}

function showAssign(id) {
  const box = document.getElementById('assignBox');
  if (assignOpen && assignRid === id) {
    assignOpen = false; assignRid = null;
    box.style.display = 'none'; return;
  }
  assignOpen = true; assignRid = id;
  const sel = document.getElementById('adminRestaurant');
  if (sel) sel.value = String(id);
  box.style.display = 'block';
  loadAdminsFor(id);
}

async function createOrAssignAdmin() {
  if (!me?.is_admin) return;
  const email = document.getElementById('adminEmail').value.trim();
  const pass  = document.getElementById('adminPassword').value;
  const rid   = parseInt(document.getElementById('adminRestaurant').value, 10);
  if (!email || !rid) { toast('Fill in email and select restaurant', 'err'); return; }

  const assign = async () => {
    const r = await api(`${API_BASE}/auth/users/assign`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email, restaurant_id:rid })
    });
    if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.detail||'assign failed'); }
  };

  try {
    if (!pass) { await assign(); toast('Admin assigned âœ“'); document.getElementById('adminEmail').value=''; return; }
    const r = await api(`${API_BASE}/auth/users`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email, password:pass, restaurant_id:rid })
    });
    if (r.ok) { toast('Admin created & assigned âœ“'); document.getElementById('adminEmail').value=''; document.getElementById('adminPassword').value=''; return; }
    const e = await r.json().catch(()=>({}));
    if (r.status===409) { await assign(); toast('Admin assigned âœ“'); return; }
    throw new Error(e.detail||'failed');
  } catch(e) { toast(e.message||'Failed', 'err'); }
}

async function loadAdminsFor(rid) {
  const box = document.getElementById('adminList');
  if (!box) return;
  box.innerHTML = `<div style="color:var(--text3);font-size:13px;padding:10px 0">Loading...</div>`;
  try {
    const data = await (await api(`${API_BASE}/auth/users/by-restaurant/${rid}`)).json();
    uCache = data;
    if (!data.length) { box.innerHTML = `<div style="color:var(--text3);font-size:13px;padding:10px 0">No admins assigned yet</div>`; return; }
    box.innerHTML = data.map(u => `
      <div class="admin-user-row">
        <div class="admin-user-info">
          <div class="admin-user-email">${esc(u.email)}</div>
          <div class="admin-user-status">${u.active ? 'â— Active' : 'â—‹ Inactive'}</div>
        </div>
        <div class="admin-user-btns">
          <button class="btn btn-secondary btn-xs" onclick="openEditUser(${u.id})">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4z"/></svg>
            Edit
          </button>
          <button class="btn ${u.active ? 'btn-danger' : 'btn-success'} btn-xs" onclick="setUserStatus(${u.id},${!u.active})">
            ${u.active ? 'Revoke' : 'Restore'}
          </button>
          <button class="btn btn-danger btn-xs" onclick="deleteUser(${u.id})">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
          </button>
        </div>
      </div>`).join('');
  } catch { box.innerHTML = `<div style="color:var(--red);font-size:13px">Failed to load admins</div>`; }
}

function openEditUser(uid) {
  const u = uCache.find(x => x.id===uid);
  if (!u) return;
  editUid = uid;
  document.getElementById('editEmail').value    = u.email||'';
  document.getElementById('editPassword').value = '';
  document.getElementById('editErr').textContent = '';
  document.getElementById('editUserOverlay').classList.remove('hidden');
  document.getElementById('editEmail').focus();
}

function closeEditUser() {
  editUid = null;
  document.getElementById('editUserOverlay').classList.add('hidden');
  document.getElementById('editErr').textContent = '';
}

document.getElementById('editUserOverlay').addEventListener('click', e => {
  if (e.target.id==='editUserOverlay') closeEditUser();
});

document.addEventListener('keydown', e => { if (e.key==='Escape') closeEditUser(); });

document.getElementById('editPassword').addEventListener('keydown', e => { if (e.key==='Enter') saveEditUser(); });

async function saveEditUser() {
  if (!editUid) return;
  const email = document.getElementById('editEmail').value.trim().toLowerCase();
  const pass  = document.getElementById('editPassword').value.trim();
  const err   = document.getElementById('editErr');
  if (!email || !email.includes('@')) { err.textContent='Invalid email'; return; }
  if (pass && pass.length<6) { err.textContent='Password must be 6+ characters'; return; }
  const payload = { email };
  if (pass) payload.password = pass;
  try {
    const r = await api(`${API_BASE}/auth/users/${editUid}`, {
      method:'PUT', headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if (!r.ok) { const e=await r.json().catch(()=>({})); throw new Error(e.detail||'Failed'); }
    closeEditUser();
    const rid = selId || parseInt(document.getElementById('adminRestaurant')?.value||'0',10);
    if (rid) loadAdminsFor(rid);
    toast('User updated âœ“');
  } catch(e) { err.textContent = e.message||'Failed'; }
}

async function deleteUser(uid) {
  if (!confirm('Delete this user? This cannot be undone.')) return;
  try {
    const r = await api(`${API_BASE}/auth/users/${uid}`, { method:'DELETE' });
    if (!r.ok) throw new Error();
    const rid = selId || parseInt(document.getElementById('adminRestaurant')?.value||'0',10);
    if (rid) loadAdminsFor(rid);
    toast('User deleted');
  } catch { toast('Delete failed', 'err'); }
}

async function setUserStatus(uid, active) {
  try {
    await api(`${API_BASE}/auth/users/${uid}/status`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ active })
    });
    const rid = selId || parseInt(document.getElementById('adminRestaurant')?.value||'0',10);
    if (rid) loadAdminsFor(rid);
    toast(active ? 'Access restored' : 'Access revoked');
  } catch { toast('Failed', 'err'); }
}

function buildTwilioUrl(id) {
  const base = String(localStorage.getItem('twilioBaseUrl')||'').trim().replace(/\/+$/,'') || API_BASE;
  const clean = base.replace(/\/incoming-call(?:\/\d+)?(?:\?.*)?$/i,'');
  return `${clean}/incoming-call/${id}`;
}

function copyTwilioUrl() {
  const el = document.getElementById('twilioUrl');
  navigator.clipboard.writeText(el.value)
    .then(() => toast('URL copied âœ“'))
    .catch(() => toast('Copy failed', 'err'));
}

function setVoiceBtnState(on) {
  const b = document.getElementById('voiceBtn');
  if (!b) return;
  b.textContent = on ? 'â¹ End Voice Session' : 'ğŸ™ï¸ Start Voice Session';
  b.classList.toggle('active', on);
  b.disabled = false;
}

function stopVoice() {
  try { vs.pc?.getSenders()?.forEach(s => s.track?.stop()); } catch {}
  try { vs.stream?.getTracks()?.forEach(t => t.stop()); } catch {}
  try { vs.dc?.close(); } catch {}
  try { vs.pc?.close(); } catch {}
  if (vs.audio) { vs.audio.srcObject=null; vs.audio.remove(); }
  vs = { pc:null, stream:null, audio:null, dc:null, on:false };
  resetOC();
  setVoiceBtnState(false);
}

async function startVoice() {
  if (vs.on) { stopVoice(); return; }
  if (!selId) { toast('Select a restaurant first', 'err'); return; }
  if (!window.isSecureContext || !navigator.mediaDevices?.getUserMedia) {
    toast('Voice requires HTTPS', 'err'); return;
  }
  resetOC();
  const prompt = document.getElementById(`rpr-${selId}`)?.value || '';
  const btn = document.getElementById('voiceBtn');
  if (btn) btn.disabled = true;
  try {
    const session = await (await api(`${API_BASE}/voice-session`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ restaurant_prompt:prompt })
    })).json();
    if (!session.client_secret?.value) { toast('Voice session error', 'err'); return; }

    const pc = new RTCPeerConnection();
    const dc = pc.createDataChannel('oai-events');
    dc.onmessage = e => handleRTEvent(e.data);

    const audio = document.createElement('audio');
    audio.autoplay = true;
    pc.ontrack = e => audio.srcObject = e.streams[0];

    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const sdpRes = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(session.model||'gpt-4o-realtime-preview')}`, {
      method:'POST', body:offer.sdp,
      headers:{ Authorization:`Bearer ${session.client_secret.value}`, 'Content-Type':'application/sdp' }
    });
    if (!sdpRes.ok) throw new Error('sdp failed');
    const sdp = await sdpRes.text();
    if (!sdp) throw new Error('empty sdp');
    await pc.setRemoteDescription({ type:'answer', sdp });

    vs = { pc, stream, audio, dc, on:true };
    pc.onconnectionstatechange = () => {
      if (vs.pc !== pc) return;
      if (['failed','disconnected','closed'].includes(pc.connectionState)) stopVoice();
    };
    setVoiceBtnState(true);
    toast('Voice session started');
  } catch { stopVoice(); toast('Voice session error', 'err'); }
  finally { document.getElementById('voiceBtn')?.removeAttribute('disabled'); }
}

// â”€â”€â”€ RESTAURANT DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openR(id, silent) {
  selId = id;
  const r = rCache.find(x => x.id===id);
  if (!r) return;

  const admin  = !!me?.is_admin;
  const active = r.active;

  document.getElementById('rdetail').innerHTML = `

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ½ï¸</div>
        <div class="card-title">${esc(r.name||'Unnamed')}</div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
          <span class="badge ${active?'badge-green':'badge-red'}">${active?'Active':'Inactive'}</span>
          ${admin ? `
          <button class="btn btn-secondary btn-sm" onclick="toggleR(${r.id})">${active?'â¸ Deactivate':'â–¶ Activate'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteR(${r.id})">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
            Delete
          </button>` : ''}
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input id="rn-${r.id}" value="${esc(r.name||'')}" placeholder="Restaurant Name">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input id="rp-${r.id}" value="${esc(r.phone||'')}" placeholder="+1 (555) 000-0000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">IVR Prompt</label>
        <textarea id="rpr-${r.id}">${esc(r.ivr_text||'')}</textarea>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary btn-sm" onclick="updateR(${r.id})">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></svg>
          Save Changes
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ’¬</div>
        <div class="card-title">Test Chat</div>
      </div>
      <div class="chat-box" id="chat"></div>
      <div class="chat-row">
        <input id="chatIn" placeholder="Type a message to test the AI..." onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary btn-sm" onclick="sendChat()">Send</button>
      </div>
    </div>

    ${admin ? `
    <div class="card">
      <div class="section-lbl">Admins for this restaurant</div>
      <div id="adminList"></div>
    </div>` : ''}

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ™ï¸</div>
        <div class="card-title">Voice Test</div>
      </div>
      <p style="font-size:13.5px;color:var(--text2);margin-bottom:10px;line-height:1.6">
        Start a real-time voice session directly in your browser to test the AI receptionist.
        Requires HTTPS and microphone permission.
      </p>
      <button class="voice-btn" id="voiceBtn" onclick="startVoice()">ğŸ™ï¸ Start Voice Session</button>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-icon">ğŸ“¡</div>
        <div class="card-title">Twilio Webhook</div>
      </div>
      <div class="form-group">
        <label class="form-label">Webhook URL â€” paste this into Twilio</label>
        <div class="twilio-row">
          <input id="twilioUrl" readonly value="${esc(buildTwilioUrl(r.id))}">
          <button class="btn btn-secondary btn-sm" onclick="copyTwilioUrl()">Copy</button>
        </div>
      </div>
      <p style="font-size:12.5px;color:var(--text3);line-height:1.7;margin-top:10px">
        Go to <strong style="color:var(--text2)">Twilio Console â†’ Phone Numbers â†’ Active Numbers</strong>,
        select your number, set <em>Voice â†’ A Call Comes In</em> to <strong style="color:var(--text2)">Webhook</strong>,
        paste the URL above, and save with <strong style="color:var(--text2)">HTTP POST</strong>.
      </p>
    </div>
  `;

  setVoiceBtnState(vs.on);
  if (admin) loadAdminsFor(r.id);
  if (!silent) loadRestaurants();
}

// â”€â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendChat() {
  if (!selId) { toast('Select a restaurant first', 'err'); return; }
  const msg = document.getElementById('chatIn').value.trim();
  if (!msg) return;
  const prompt = document.getElementById(`rpr-${selId}`)?.value || '';
  const chat = document.getElementById('chat');
  chat.innerHTML += `<div class="msg user"><div class="msg-sender">You</div><div class="msg-bubble">${esc(msg)}</div></div>`;
  document.getElementById('chatIn').value = '';
  chat.scrollTop = chat.scrollHeight;
  const tid = 'typing-' + Date.now();
  chat.innerHTML += `<div class="msg ai" id="${tid}"><div class="msg-sender">AI</div><div class="msg-bubble"><span class="spin"></span></div></div>`;
  chat.scrollTop = chat.scrollHeight;
  try {
    const r = await api(`${API_BASE}/chat`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ message:msg, restaurant_prompt:prompt })
    });
    const d = await r.json();
    if (!r.ok || !d.reply) throw new Error();
    document.getElementById(tid).outerHTML = `<div class="msg ai"><div class="msg-sender">AI</div><div class="msg-bubble">${esc(d.reply)}</div></div>`;
  } catch {
    document.getElementById(tid).outerHTML = `<div class="msg ai"><div class="msg-sender">AI</div><div class="msg-bubble" style="color:var(--red)">Server error â€” please try again</div></div>`;
  }
  chat.scrollTop = chat.scrollHeight;
}

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  if (inited) return;
  inited = true;
  await Promise.allSettled([loadGlobal(), loadRestaurants(), loadStats(), loadLogs()]);
}

// Apply sidebar state
if (collapsed) document.body.classList.add('collapsed');

// Apply language
if (lang !== 'en') setLang(lang);

// Init
checkAuth().then(ok => { if (ok) boot(); });
</script>
</body>
</html>