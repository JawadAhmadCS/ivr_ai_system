<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<title>AI Call Center Dashboard</title>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
.sidebar{width:240px;background:#020617;height:100vh;position:fixed;padding:20px}
.sidebar h2{margin-bottom:30px}
.sidebar button{display:block;width:100%;margin:8px 0;padding:12px;background:#111827;border:none;color:#fff;cursor:pointer;text-align:left}
.main{margin-left:260px;padding:30px}
.card{background:#020617;padding:20px;margin-bottom:20px;border-radius:10px}
input,textarea{width:100%;padding:10px;margin-top:10px;background:#020617;border:1px solid #333;color:#fff}
button.primary{background:#2563eb;padding:12px;border:none;margin-top:10px;cursor:pointer}
#chatbox{height:250px;overflow:auto;background:#000;padding:10px;margin-top:10px}
.restaurantBox{border:1px solid #333;padding:15px;margin-top:15px}
</style>

</head>

<body>

<div class="sidebar">
<h2>AI Admin</h2>
<button onclick="show('dashboard')">Dashboard</button>
<button onclick="show('restaurants')">Restaurants + Agents</button>
</div>

<div class="main">

<!-- DASHBOARD -->

<div id="dashboard" class="page">
<div class="card"><h2>System Overview</h2>
Active Restaurants: <b id="rCount">0</b><br>
</div>
</div>

<!-- RESTAURANTS -->

<div id="restaurants" class="page" style="display:none">

<div class="card">
<h3>Add New Restaurant</h3>
<input id="rname" placeholder="Restaurant name">
<input id="rphone" placeholder="Phone">
<textarea id="rprompt" placeholder="Agent prompt (Hebrew etc)"></textarea>
<button class="primary" onclick="addRestaurant()">Create Restaurant</button>
</div>

<div class="card">
<h3>All Restaurants & Agents</h3>
<div id="rlist"></div>
</div>

</div>

</div>

<script>
let DEFAULT_PROMPT="You are a restaurant AI call assistant. Speak Hebrew. Short replies.";
let restaurants=[];
let selectedRestaurant=null;

function show(id){
document.querySelectorAll(".page").forEach(p=>p.style.display="none")
document.getElementById(id).style.display="block"
}

/* add restaurant */
function addRestaurant(){
let name=document.getElementById("rname").value
let phone=document.getElementById("rphone").value
let prompt=document.getElementById("rprompt").value || DEFAULT_PROMPT

if(!name) return alert("Enter name")

restaurants.push({
name:name,
phone:phone,
prompt:prompt,
active:true
})

renderRestaurants()
updateStats()
}

/* render */
function renderRestaurants(){
let html=""

restaurants.forEach((r,i)=>{
html+=`
<div class="restaurantBox">

<b>${r.name}</b> (${r.phone})<br><br>

<b>Agent Prompt:</b>
<textarea id="prompt${i}">${r.prompt}</textarea>

<button onclick="savePrompt(${i})">Save Prompt</button> <button onclick="selectRestaurant(${i})">Use This Agent</button> <button onclick="deleteRestaurant(${i})">Delete</button>

<hr>

<b>AI Chat Test</b>

<div id="chat${i}" style="height:150px;overflow:auto;background:#000;padding:8px"></div>
<input id="msg${i}" placeholder="type message">
<button onclick="sendChat(${i})">Send</button>

<br><br> <b>Voice Test</b><br> <button onclick="startVoice(${i})">Start Talking</button>

</div>
`
})

document.getElementById("rlist").innerHTML=html
}

/* save prompt */
function savePrompt(i){
restaurants[i].prompt=document.getElementById("prompt"+i).value
alert("Prompt updated")
}

/* select */
function selectRestaurant(i){
selectedRestaurant=restaurants[i]
alert("Active agent: "+selectedRestaurant.name)
}

/* delete */
function deleteRestaurant(i){
restaurants.splice(i,1)
renderRestaurants()
updateStats()
}

/* stats */
function updateStats(){
document.getElementById("rCount").innerText=restaurants.length
}

/* CHAT */
async function sendChat(i){
let msg=document.getElementById("msg"+i).value
if(!msg) return

let chatBox=document.getElementById("chat"+i)
chatBox.innerHTML+="<b>You:</b> "+msg+"<br>"

let r = await fetch("http://localhost:5050/chat",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
message:msg,
system_prompt:restaurants.prompt
})
})

let data = await r.json()
chatBox.innerHTML+="<b>AI:</b> "+data.reply+"<br><br>"
chatBox.scrollTop=chatBox.scrollHeight
}

/* VOICE */
async function startVoice(i){

const tokenResponse = await fetch("http://localhost:5050/voice-session",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
system_prompt:restaurants.prompt
})
});

const session = await tokenResponse.json();
const EPHEMERAL_KEY = session.client_secret.value;

const pc = new RTCPeerConnection();
const audioEl = document.createElement("audio");
audioEl.autoplay = true;
pc.ontrack = e => audioEl.srcObject = e.streams[0];

const stream = await navigator.mediaDevices.getUserMedia({audio:true});
stream.getTracks().forEach(track => pc.addTrack(track, stream));

const dc = pc.createDataChannel("oai-events");

const offer = await pc.createOffer();
await pc.setLocalDescription(offer);

const baseUrl = "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview";

const sdpResponse = await fetch(baseUrl,{
method:"POST",
body: offer.sdp,
headers:{
Authorization:`Bearer ${EPHEMERAL_KEY}`,
"Content-Type":"application/sdp"
}
});

const answer={type:"answer",sdp:await sdpResponse.text()}
await pc.setRemoteDescription(answer);
}

</script>
</body>
</html>
